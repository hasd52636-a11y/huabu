<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•åˆ†äº«æŒ‰é’®ç‚¹å‡»</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-8 bg-gray-100">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, createContext, useContext } = React;
        
        // ç®€åŒ–çš„ ShareProvider å®ç°
        const ShareContext = createContext();
        
        const ShareProvider = ({ children, config }) => {
            const [session, setSession] = useState({
                shareId: null,
                status: 'idle',
                viewers: [],
                isHost: false,
            });
            const [receivedData, setReceivedData] = useState(null);
            
            const createShare = async (title) => {
                console.log('åˆ›å»ºåˆ†äº«:', title);
                const shareId = `test-${Date.now()}`;
                setSession(prev => ({ ...prev, shareId, isHost: true, status: 'connected' }));
                return { shareId, shareUrl: `${window.location.origin}?watch=${shareId}` };
            };
            
            const stopSharing = () => {
                console.log('åœæ­¢åˆ†äº«');
                setSession({ shareId: null, status: 'idle', viewers: [], isHost: false });
            };
            
            const syncData = (data) => {
                console.log('åŒæ­¥æ•°æ®:', data);
            };
            
            return React.createElement(ShareContext.Provider, {
                value: { session, createShare, stopSharing, syncData, receivedData }
            }, children);
        };
        
        const useShare = () => {
            const context = useContext(ShareContext);
            if (!context) throw new Error('useShare must be used within a ShareProvider');
            return context;
        };
        
        // ç®€åŒ–çš„ ToolbarShareButton å®ç°
        const ToolbarShareButtonInternal = ({ data, onDataChange, className, title }) => {
            const { session, createShare, stopSharing, syncData, receivedData } = useShare();
            const [copied, setCopied] = useState(false);
            const [showUrl, setShowUrl] = useState(false);
            
            const handleToggle = async () => {
                console.log('æŒ‰é’®è¢«ç‚¹å‡»ï¼Œå½“å‰çŠ¶æ€:', session);
                
                if (session.shareId) {
                    stopSharing();
                    setShowUrl(false);
                } else {
                    const result = await createShare('æµ‹è¯•åˆ†äº«');
                    console.log('åˆ†äº«å·²åˆ›å»º:', result.shareUrl);
                    setShowUrl(true);
                }
            };
            
            const copyUrl = () => {
                if (session.shareId) {
                    const url = `${window.location.origin}?watch=${session.shareId}`;
                    navigator.clipboard.writeText(url);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                }
            };
            
            return React.createElement('div', { className: 'relative' }, [
                React.createElement('button', {
                    key: 'button',
                    onClick: handleToggle,
                    className: `${className} ${session.shareId ? 'text-green-500 hover:text-green-600' : 'text-slate-400 hover:text-amber-500'} transition-all relative border border-gray-300 rounded`,
                    title: session.shareId ? 'åœæ­¢åˆ†äº«' : (title || 'åˆ†äº«ç”»å¸ƒ')
                }, session.shareId ? 'åœæ­¢åˆ†äº«' : 'å¼€å§‹åˆ†äº«'),
                
                showUrl && session.shareId && React.createElement('div', {
                    key: 'popup',
                    className: 'absolute left-full ml-2 top-0 bg-white border border-gray-200 rounded-lg shadow-lg p-3 min-w-[300px] z-50'
                }, [
                    React.createElement('div', {
                        key: 'header',
                        className: 'flex items-center justify-between mb-2'
                    }, [
                        React.createElement('span', {
                            key: 'title',
                            className: 'text-sm font-medium text-gray-700'
                        }, 'åˆ†äº«é“¾æ¥'),
                        React.createElement('button', {
                            key: 'close',
                            onClick: () => setShowUrl(false),
                            className: 'text-gray-400 hover:text-gray-600'
                        }, 'Ã—')
                    ]),
                    
                    React.createElement('div', {
                        key: 'link',
                        className: 'flex items-center gap-2 mb-2'
                    }, [
                        React.createElement('input', {
                            key: 'input',
                            readOnly: true,
                            value: `${window.location.origin}?watch=${session.shareId}`,
                            className: 'text-xs text-gray-600 bg-gray-50 px-2 py-1 rounded border flex-1 outline-none'
                        }),
                        React.createElement('button', {
                            key: 'copy',
                            onClick: copyUrl,
                            className: 'p-1.5 hover:bg-gray-100 rounded text-gray-600 transition-colors',
                            title: 'å¤åˆ¶é“¾æ¥'
                        }, copied ? 'âœ“' : 'ğŸ“‹')
                    ])
                ])
            ]);
        };
        
        const ToolbarShareButton = ({ data, onDataChange, className = "p-3", title = "åˆ†äº«ç”»å¸ƒ" }) => {
            return React.createElement(ShareProvider, {
                config: { 
                    appName: "æµ‹è¯•åº”ç”¨",
                    maxViewers: 5
                }
            }, React.createElement(ToolbarShareButtonInternal, {
                data,
                onDataChange,
                className,
                title
            }));
        };
        
        // æµ‹è¯•åº”ç”¨
        const TestApp = () => {
            const [testData, setTestData] = useState({ message: 'æµ‹è¯•æ•°æ®' });
            
            return React.createElement('div', { className: 'max-w-2xl mx-auto' }, [
                React.createElement('h1', {
                    key: 'title',
                    className: 'text-2xl font-bold mb-4'
                }, 'åˆ†äº«æŒ‰é’®ç‚¹å‡»æµ‹è¯•'),
                
                React.createElement('div', {
                    key: 'test',
                    className: 'bg-white p-4 rounded-lg shadow mb-4'
                }, [
                    React.createElement('h2', {
                        key: 'subtitle',
                        className: 'text-lg font-semibold mb-2'
                    }, 'æµ‹è¯•æŒ‰é’®'),
                    
                    React.createElement(ToolbarShareButton, {
                        key: 'button',
                        data: testData,
                        onDataChange: setTestData,
                        className: 'px-4 py-2',
                        title: 'æµ‹è¯•åˆ†äº«'
                    })
                ]),
                
                React.createElement('div', {
                    key: 'instructions',
                    className: 'bg-blue-50 p-4 rounded-lg'
                }, [
                    React.createElement('h3', {
                        key: 'title',
                        className: 'font-semibold mb-2'
                    }, 'æµ‹è¯•è¯´æ˜:'),
                    React.createElement('ul', {
                        key: 'list',
                        className: 'list-disc list-inside space-y-1 text-sm'
                    }, [
                        React.createElement('li', { key: '1' }, 'ç‚¹å‡»æŒ‰é’®åº”è¯¥æ˜¾ç¤º"å¼€å§‹åˆ†äº«"æˆ–"åœæ­¢åˆ†äº«"'),
                        React.createElement('li', { key: '2' }, 'ç‚¹å‡»ååº”è¯¥åœ¨æ§åˆ¶å°çœ‹åˆ°æ—¥å¿—'),
                        React.createElement('li', { key: '3' }, 'åˆ†äº«æ—¶åº”è¯¥æ˜¾ç¤ºåˆ†äº«é“¾æ¥å¼¹å‡ºæ¡†'),
                        React.createElement('li', { key: '4' }, 'å¦‚æœæŒ‰é’®æ— å“åº”ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯')
                    ])
                ])
            ]);
        };
        
        // æ¸²æŸ“åº”ç”¨
        ReactDOM.render(React.createElement(TestApp), document.getElementById('root'));
    </script>
</body>
</html>