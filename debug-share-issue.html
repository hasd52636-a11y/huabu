<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†äº«é—®é¢˜è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .error { color: #d32f2f; }
        .success { color: #388e3c; }
        .warning { color: #f57c00; }
        .info { color: #1976d2; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1565c0;
        }
    </style>
</head>
<body>
    <h1>ğŸ” åˆ†äº«é—®é¢˜è°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-section">
        <h2>é—®é¢˜åˆ†äº«IDåˆ†æ</h2>
        <p><strong>åˆ†äº«ID:</strong> <code>share-1769056688844-v3iise</code></p>
        <div id="shareAnalysis"></div>
    </div>

    <div class="debug-section">
        <h2>localStorage æ•°æ®æ£€æŸ¥</h2>
        <div id="storageCheck"></div>
        <button onclick="checkStorage()">æ£€æŸ¥å­˜å‚¨</button>
        <button onclick="clearStorage()">æ¸…ç†å­˜å‚¨</button>
    </div>

    <div class="debug-section">
        <h2>åˆ›å»ºæµ‹è¯•åˆ†äº«æ•°æ®</h2>
        <div id="testDataResult"></div>
        <button onclick="createTestShare()">åˆ›å»ºæµ‹è¯•åˆ†äº«</button>
        <button onclick="createValidShare()">åˆ›å»ºæœ‰æ•ˆåˆ†äº«æ•°æ®</button>
    </div>

    <div class="debug-section">
        <h2>åˆ†äº«æœåŠ¡æµ‹è¯•</h2>
        <div id="serviceTest"></div>
        <button onclick="testShareService()">æµ‹è¯•åˆ†äº«æœåŠ¡</button>
    </div>

    <script>
        const problematicId = 'share-1769056688844-v3iise';
        
        function log(message, type = 'info') {
            const colors = {
                error: '#d32f2f',
                success: '#388e3c', 
                warning: '#f57c00',
                info: '#1976d2'
            };
            console.log(`%c[DEBUG] ${message}`, `color: ${colors[type]}`);
        }

        function displayResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${content}</div>`;
        }

        function checkStorage() {
            log('æ£€æŸ¥localStorageä¸­çš„åˆ†äº«æ•°æ®');
            
            const results = [];
            const keys = Object.keys(localStorage);
            const shareKeys = keys.filter(key => key.startsWith('share-session-'));
            
            results.push(`<h3>å‘ç° ${shareKeys.length} ä¸ªåˆ†äº«ä¼šè¯</h3>`);
            
            shareKeys.forEach(key => {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    const sessionId = key.replace('share-session-', '');
                    
                    results.push(`
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <strong>ä¼šè¯ID:</strong> ${sessionId}<br>
                            <strong>æ ‡é¢˜:</strong> ${data.title || 'æ— æ ‡é¢˜'}<br>
                            <strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(data.createdAt).toLocaleString()}<br>
                            <strong>æ˜¯å¦æ´»è·ƒ:</strong> ${data.isActive ? 'æ˜¯' : 'å¦'}<br>
                            <strong>ç”»å¸ƒå—æ•°:</strong> ${data.canvasState?.blocks?.length || 0}<br>
                            <strong>è§‚ä¼—æ•°:</strong> ${data.viewers?.length || 0}<br>
                            ${sessionId === problematicId ? '<span class="error">âš ï¸ è¿™æ˜¯é—®é¢˜ID</span>' : ''}
                        </div>
                    `);
                } catch (error) {
                    results.push(`<div class="error">âŒ ${key}: æ•°æ®æŸå - ${error.message}</div>`);
                }
            });
            
            // æ£€æŸ¥é—®é¢˜ID
            const problematicKey = `share-session-${problematicId}`;
            if (localStorage.getItem(problematicKey)) {
                results.push(`<div class="warning">âš ï¸ å‘ç°é—®é¢˜IDæ•°æ®ï¼Œå°è¯•è§£æ...</div>`);
                try {
                    const data = JSON.parse(localStorage.getItem(problematicKey));
                    results.push(`<pre>${JSON.stringify(data, null, 2)}</pre>`);
                } catch (error) {
                    results.push(`<div class="error">âŒ é—®é¢˜IDæ•°æ®å®Œå…¨æŸå: ${error.message}</div>`);
                }
            } else {
                results.push(`<div class="info">â„¹ï¸ é—®é¢˜IDæ•°æ®ä¸å­˜åœ¨</div>`);
            }
            
            displayResult('storageCheck', results.join(''));
        }

        function clearStorage() {
            try {
                const keys = Object.keys(localStorage);
                const shareKeys = keys.filter(key => key.startsWith('share-session-'));
                
                shareKeys.forEach(key => {
                    localStorage.removeItem(key);
                });
                
                displayResult('storageCheck', `âœ… å·²æ¸…ç† ${shareKeys.length} ä¸ªåˆ†äº«ä¼šè¯æ•°æ®`, 'success');
                log(`æ¸…ç†äº† ${shareKeys.length} ä¸ªåˆ†äº«ä¼šè¯`, 'success');
            } catch (error) {
                displayResult('storageCheck', `âŒ æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
                log(`æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function createTestShare() {
            log('åˆ›å»ºæµ‹è¯•åˆ†äº«æ•°æ®');
            
            const testSession = {
                id: 'test-share-123',
                hostId: 'host-test-123',
                title: 'æµ‹è¯•åˆ†äº«ä¼šè¯',
                createdAt: Date.now(),
                lastUpdate: Date.now(),
                canvasState: {
                    blocks: [
                        {
                            id: 'block-1',
                            type: 'text',
                            x: 100,
                            y: 100,
                            width: 200,
                            height: 100,
                            content: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡æœ¬å—'
                        }
                    ],
                    connections: [],
                    zoom: 1,
                    pan: { x: 0, y: 0 }
                },
                viewers: [],
                isActive: true,
                connectionMode: {
                    type: 'polling',
                    priority: 2,
                    config: {
                        pollInterval: 1000,
                        timeout: 10000,
                        retryAttempts: 5
                    }
                },
                quality: {
                    level: 'good',
                    latency: 200,
                    bandwidth: 500,
                    stability: 0.8,
                    lastMeasured: Date.now()
                },
                settings: {
                    maxViewers: 10,
                    autoReconnect: true,
                    compressionEnabled: true,
                    updateThrottle: 500,
                    qualityAdaptive: true
                }
            };
            
            try {
                localStorage.setItem(`share-session-${testSession.id}`, JSON.stringify(testSession));
                displayResult('testDataResult', 'âœ… æµ‹è¯•åˆ†äº«æ•°æ®åˆ›å»ºæˆåŠŸï¼å¯ä»¥è®¿é—®: http://localhost:3005/?watch=test-share-123', 'success');
                log('æµ‹è¯•åˆ†äº«æ•°æ®åˆ›å»ºæˆåŠŸ', 'success');
            } catch (error) {
                displayResult('testDataResult', `âŒ åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
                log(`åˆ›å»ºæµ‹è¯•æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function createValidShare() {
            log('ä¸ºé—®é¢˜IDåˆ›å»ºæœ‰æ•ˆæ•°æ®');
            
            const validSession = {
                id: problematicId,
                hostId: 'host-fixed-123',
                title: 'ä¿®å¤åçš„åˆ†äº«ä¼šè¯',
                createdAt: Date.now() - 3600000, // 1å°æ—¶å‰åˆ›å»º
                lastUpdate: Date.now(),
                canvasState: {
                    blocks: [
                        {
                            id: 'block-1',
                            type: 'text',
                            x: 150,
                            y: 150,
                            width: 300,
                            height: 120,
                            content: 'è¿™æ˜¯ä¿®å¤åçš„åˆ†äº«å†…å®¹\n\nç°åœ¨åº”è¯¥å¯ä»¥æ­£å¸¸æ˜¾ç¤ºäº†ï¼'
                        },
                        {
                            id: 'block-2',
                            type: 'text',
                            x: 500,
                            y: 200,
                            width: 250,
                            height: 80,
                            content: 'åˆ†äº«åŠŸèƒ½å·²æ¢å¤æ­£å¸¸'
                        }
                    ],
                    connections: [],
                    zoom: 1,
                    pan: { x: 0, y: 0 }
                },
                viewers: [],
                isActive: true,
                connectionMode: {
                    type: 'polling',
                    priority: 2,
                    config: {
                        pollInterval: 1000,
                        timeout: 10000,
                        retryAttempts: 5
                    }
                },
                quality: {
                    level: 'good',
                    latency: 150,
                    bandwidth: 800,
                    stability: 0.9,
                    lastMeasured: Date.now()
                },
                settings: {
                    maxViewers: 10,
                    autoReconnect: true,
                    compressionEnabled: false,
                    updateThrottle: 500,
                    qualityAdaptive: true
                }
            };
            
            try {
                localStorage.setItem(`share-session-${problematicId}`, JSON.stringify(validSession));
                displayResult('testDataResult', `âœ… é—®é¢˜IDçš„æœ‰æ•ˆæ•°æ®å·²åˆ›å»ºï¼<br>ç°åœ¨å¯ä»¥è®¿é—®: <a href="http://localhost:3005/?watch=${problematicId}" target="_blank">http://localhost:3005/?watch=${problematicId}</a>`, 'success');
                log('é—®é¢˜IDçš„æœ‰æ•ˆæ•°æ®åˆ›å»ºæˆåŠŸ', 'success');
            } catch (error) {
                displayResult('testDataResult', `âŒ åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
                log(`åˆ›å»ºæœ‰æ•ˆæ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testShareService() {
            log('æµ‹è¯•åˆ†äº«æœåŠ¡åŠŸèƒ½');
            
            // æ¨¡æ‹Ÿåˆ†äº«æœåŠ¡çš„åŸºæœ¬åŠŸèƒ½æµ‹è¯•
            const tests = [];
            
            // æµ‹è¯•1: localStorageè®¿é—®
            try {
                localStorage.setItem('test-key', 'test-value');
                const value = localStorage.getItem('test-key');
                localStorage.removeItem('test-key');
                tests.push('âœ… localStorage è®¿é—®æ­£å¸¸');
            } catch (error) {
                tests.push(`âŒ localStorage è®¿é—®å¤±è´¥: ${error.message}`);
            }
            
            // æµ‹è¯•2: JSONåºåˆ—åŒ–
            try {
                const testObj = { test: true, data: [1, 2, 3] };
                const serialized = JSON.stringify(testObj);
                const parsed = JSON.parse(serialized);
                tests.push('âœ… JSON åºåˆ—åŒ–æ­£å¸¸');
            } catch (error) {
                tests.push(`âŒ JSON åºåˆ—åŒ–å¤±è´¥: ${error.message}`);
            }
            
            // æµ‹è¯•3: URLå‚æ•°è§£æ
            try {
                const url = new URL('http://localhost:3005/?watch=test-123');
                const watchId = url.searchParams.get('watch');
                tests.push(`âœ… URLå‚æ•°è§£ææ­£å¸¸: ${watchId}`);
            } catch (error) {
                tests.push(`âŒ URLå‚æ•°è§£æå¤±è´¥: ${error.message}`);
            }
            
            displayResult('serviceTest', tests.join('<br>'));
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            log('è°ƒè¯•é¡µé¢åŠ è½½å®Œæˆ');
            checkStorage();
        };
    </script>
</body>
</html>