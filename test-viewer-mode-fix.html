<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>观看模式修复测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        #log { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; font-family: monospace; font-size: 12px; background: #f8f9fa; }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .step.completed { border-left-color: #28a745; background: #d4edda; }
        .step.error { border-left-color: #dc3545; background: #f8d7da; }
    </style>
</head>
<body>
    <h1>观看模式修复测试</h1>
    
    <div class="test-section warning">
        <h3>⚠️ 重要修复说明</h3>
        <p><strong>问题：</strong>分享链接打开后，观看者看到的是完整的可编辑应用，而不是只读的观看页面。</p>
        <p><strong>修复：</strong>现在分享链接会自动检测 <code>?watch=xxx</code> 参数，并渲染专门的只读观看页面。</p>
        <p><strong>效果：</strong>观看者只能看到内容，无法进行任何编辑操作。</p>
    </div>

    <div class="test-section info">
        <h3>测试步骤</h3>
        <div class="step" id="step1">
            <strong>步骤 1:</strong> 打开主应用，创建一些内容（文本块、图片等）
            <button class="btn-primary" onclick="openMainApp()">打开主应用</button>
        </div>
        <div class="step" id="step2">
            <strong>步骤 2:</strong> 在主应用中点击左侧工具栏的分享按钮
            <span style="color: #666;">（应该看到绿色的分享状态指示器）</span>
        </div>
        <div class="step" id="step3">
            <strong>步骤 3:</strong> 复制分享链接，然后在这里测试观看模式
            <input type="text" id="shareUrl" placeholder="粘贴分享链接..." style="width: 300px; padding: 5px; margin: 0 10px;">
            <button class="btn-success" onclick="testViewerMode()">测试观看模式</button>
        </div>
        <div class="step" id="step4">
            <strong>步骤 4:</strong> 验证观看页面特性
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li>✅ 只显示画布内容，没有编辑工具栏</li>
                <li>✅ 顶部显示"观看模式"状态栏</li>
                <li>✅ 显示连接状态和观众数量</li>
                <li>✅ 所有内容都是只读的，无法编辑</li>
                <li>✅ 可以看到主机的实时操作</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h3>快速测试</h3>
        <p>如果你已经有分享链接，可以直接测试：</p>
        <button class="btn-warning" onclick="testWithSampleId()">测试示例分享ID</button>
        <button class="btn-danger" onclick="testWithProblematicId()">测试问题分享ID</button>
        <button class="btn-primary" onclick="clearLog()">清空日志</button>
    </div>

    <div class="test-section">
        <h3>测试日志</h3>
        <div id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function markStepCompleted(stepId) {
            const step = document.getElementById(stepId);
            if (step) {
                step.classList.add('completed');
            }
        }

        function markStepError(stepId) {
            const step = document.getElementById(stepId);
            if (step) {
                step.classList.add('error');
            }
        }

        function openMainApp() {
            log('正在打开主应用...', 'info');
            window.open('http://localhost:3005/', '_blank');
            log('主应用已在新标签页中打开', 'success');
            markStepCompleted('step1');
            
            setTimeout(() => {
                log('提示：在主应用中创建一些内容，然后点击左侧工具栏的分享按钮', 'warning');
            }, 1000);
        }

        function testViewerMode() {
            const shareUrl = document.getElementById('shareUrl').value.trim();
            if (!shareUrl) {
                log('请先输入分享链接', 'error');
                return;
            }

            log(`正在测试观看模式: ${shareUrl}`, 'info');
            
            // 验证链接格式
            try {
                const url = new URL(shareUrl);
                const watchParam = url.searchParams.get('watch');
                
                if (!watchParam) {
                    log('错误：链接中没有找到 watch 参数', 'error');
                    markStepError('step3');
                    return;
                }
                
                log(`检测到分享ID: ${watchParam}`, 'success');
                log('正在打开观看页面...', 'info');
                
                window.open(shareUrl, '_blank');
                markStepCompleted('step3');
                
                setTimeout(() => {
                    log('请检查新打开的页面是否符合观看模式特性：', 'warning');
                    log('1. 顶部显示"观看模式"状态栏', 'info');
                    log('2. 没有编辑工具栏和侧边栏', 'info');
                    log('3. 显示"实时观看中 - 只读模式"提示', 'info');
                    log('4. 可以看到画布内容但无法编辑', 'info');
                }, 2000);
                
            } catch (error) {
                log(`链接格式错误: ${error.message}`, 'error');
                markStepError('step3');
            }
        }

        function testWithSampleId() {
            const sampleUrl = 'http://localhost:3005/?watch=caocao-canvas-abc123';
            document.getElementById('shareUrl').value = sampleUrl;
            log('已设置示例分享链接', 'info');
            testViewerMode();
        }

        function testWithProblematicId() {
            const problematicUrl = 'http://localhost:3005/?watch=share-1769056688844-v3iise';
            document.getElementById('shareUrl').value = problematicUrl;
            log('已设置问题分享ID（应该使用隔离查看器）', 'warning');
            testViewerMode();
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('日志已清空', 'info');
        }

        // 页面加载完成后的初始化
        window.onload = function() {
            log('观看模式修复测试页面已加载', 'success');
            log('修复内容：', 'info');
            log('- App.tsx 现在会检测 ?watch=xxx 参数', 'info');
            log('- 观看模式使用 SmartViewerRouter 自动选择合适的观看器', 'info');
            log('- 默认使用 ShareKitViewerPage（P2P实时同步，只读模式）', 'info');
            log('- 观看者无法进行任何编辑操作', 'info');
            log('请按照测试步骤进行验证', 'warning');
        };
    </script>
</body>
</html>