<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°åˆ†äº«æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .success { background: #d4edda; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; }
        .info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .share-url {
            background: white;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <h1>ğŸ”— æœ¬åœ°åˆ†äº«åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section info">
        <h3>æµ‹è¯•è¯´æ˜</h3>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•æœ¬åœ°åˆ†äº«åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚</p>
        <ol>
            <li>ç‚¹å‡»"åˆ›å»ºæµ‹è¯•åˆ†äº«"æŒ‰é’®åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿåˆ†äº«</li>
            <li>å¤åˆ¶ç”Ÿæˆçš„åˆ†äº«é“¾æ¥</li>
            <li>åœ¨æ–°çš„æµè§ˆå™¨æ ‡ç­¾é¡µä¸­æ‰“å¼€é“¾æ¥</li>
            <li>æ£€æŸ¥æ˜¯å¦èƒ½æ­£å¸¸æ˜¾ç¤ºè§‚çœ‹ç•Œé¢</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>æ­¥éª¤ 1: åˆ›å»ºæµ‹è¯•åˆ†äº«</h3>
        <button onclick="createTestShare()">åˆ›å»ºæµ‹è¯•åˆ†äº«</button>
        <div id="shareResult"></div>
    </div>

    <div class="test-section">
        <h3>æ­¥éª¤ 2: æµ‹è¯•åˆ†äº«é“¾æ¥</h3>
        <p>å°†ä¸Šé¢ç”Ÿæˆçš„é“¾æ¥åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€ï¼Œåº”è¯¥æ˜¾ç¤ºè§‚çœ‹ç•Œé¢ã€‚</p>
        <button onclick="testShareLink()" id="testButton" disabled>æµ‹è¯•åˆ†äº«é“¾æ¥</button>
    </div>

    <div class="test-section">
        <h3>æ­¥éª¤ 3: æ£€æŸ¥æœ¬åœ°å­˜å‚¨</h3>
        <button onclick="checkLocalStorage()">æ£€æŸ¥ localStorage</button>
        <div id="storageResult"></div>
    </div>

    <script>
        let currentShareId = null;
        let currentShareUrl = null;

        function createTestShare() {
            // ç”Ÿæˆæµ‹è¯•åˆ†äº«ID
            const shareId = 'share-' + Date.now() + '-' + Math.random().toString(36).substring(2, 8);
            const url = `${window.location.origin}${window.location.pathname.replace('test-local-sharing.html', 'index.html')}?watch=${shareId}`;
            
            // åˆ›å»ºæµ‹è¯•ç”»å¸ƒæ•°æ®
            const testCanvasState = {
                blocks: [
                    {
                        id: 'test-block-1',
                        type: 'text',
                        content: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡æœ¬å—',
                        x: 100,
                        y: 100,
                        width: 200,
                        height: 100
                    },
                    {
                        id: 'test-block-2',
                        type: 'image',
                        content: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzQyODVmNCIvPjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+æµ‹è¯•å›¾ç‰‡</dGV4dD48L3N2Zz4=',
                        x: 350,
                        y: 100,
                        width: 200,
                        height: 200
                    }
                ],
                connections: [],
                zoom: 1,
                pan: { x: 200, y: 100 }
            };

            // ä¿å­˜åˆ° localStorage
            const shareData = {
                shareId: shareId,
                timestamp: Date.now(),
                canvasState: testCanvasState,
                status: 'active',
                message: 'æµ‹è¯•åˆ†äº«åŠŸèƒ½ - è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„ç”»å¸ƒçŠ¶æ€'
            };

            localStorage.setItem(`canvas-share-${shareId}`, JSON.stringify(shareData));

            // æ˜¾ç¤ºç»“æœ
            currentShareId = shareId;
            currentShareUrl = url;
            
            document.getElementById('shareResult').innerHTML = `
                <div class="success">
                    <h4>âœ… æµ‹è¯•åˆ†äº«åˆ›å»ºæˆåŠŸï¼</h4>
                    <p><strong>åˆ†äº«ID:</strong> ${shareId}</p>
                    <p><strong>åˆ†äº«é“¾æ¥:</strong></p>
                    <div class="share-url">${url}</div>
                    <button onclick="copyToClipboard('${url}')">å¤åˆ¶é“¾æ¥</button>
                </div>
            `;

            // å¯ç”¨æµ‹è¯•æŒ‰é’®
            document.getElementById('testButton').disabled = false;
        }

        function testShareLink() {
            if (currentShareUrl) {
                window.open(currentShareUrl, '_blank');
            } else {
                alert('è¯·å…ˆåˆ›å»ºæµ‹è¯•åˆ†äº«');
            }
        }

        function checkLocalStorage() {
            const keys = Object.keys(localStorage).filter(key => key.startsWith('canvas-share-'));
            let html = '<h4>localStorage ä¸­çš„åˆ†äº«æ•°æ®:</h4>';
            
            if (keys.length === 0) {
                html += '<p>æ²¡æœ‰æ‰¾åˆ°åˆ†äº«æ•°æ®</p>';
            } else {
                keys.forEach(key => {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        html += `
                            <div style="background: white; padding: 10px; margin: 10px 0; border-radius: 4px;">
                                <strong>${key}</strong><br>
                                åˆ†äº«ID: ${data.shareId}<br>
                                åˆ›å»ºæ—¶é—´: ${new Date(data.timestamp).toLocaleString()}<br>
                                çŠ¶æ€: ${data.status}<br>
                                ç”»å¸ƒå—æ•°é‡: ${data.canvasState?.blocks?.length || 0}<br>
                                <button onclick="deleteShare('${key}')">åˆ é™¤</button>
                            </div>
                        `;
                    } catch (e) {
                        html += `<p style="color: red;">è§£æ ${key} å¤±è´¥: ${e.message}</p>`;
                    }
                });
            }
            
            document.getElementById('storageResult').innerHTML = html;
        }

        function deleteShare(key) {
            localStorage.removeItem(key);
            checkLocalStorage();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(err => {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç°æœ‰æ•°æ®
        window.onload = function() {
            checkLocalStorage();
        };
    </script>
</body>
</html>