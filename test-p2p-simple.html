<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•P2Pæµ‹è¯•</title>
    <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; background: #007bff; color: white; }
        #log { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; font-family: monospace; font-size: 12px; background: #f8f9fa; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 200px; margin: 5px; }
    </style>
</head>
<body>
    <h1>ç®€å•P2Pè¿æ¥æµ‹è¯•</h1>
    
    <div class="section">
        <h3>ä¸»æœºç«¯</h3>
        <button onclick="createHost()">åˆ›å»ºä¸»æœº</button>
        <button onclick="sendTestData()">å‘é€æµ‹è¯•æ•°æ®</button>
        <div>ä¸»æœºID: <span id="hostId">æœªåˆ›å»º</span></div>
        <div>è¿æ¥çš„è§‚çœ‹è€…: <span id="viewerCount">0</span></div>
    </div>
    
    <div class="section">
        <h3>è§‚çœ‹è€…ç«¯</h3>
        <input type="text" id="targetId" placeholder="è¾“å…¥ä¸»æœºID" />
        <button onclick="connectToHost()">è¿æ¥ä¸»æœº</button>
        <div>è¿æ¥çŠ¶æ€: <span id="connectionStatus">æœªè¿æ¥</span></div>
    </div>
    
    <div class="section">
        <h3>æµ‹è¯•æ—¥å¿—</h3>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="log"></div>
    </div>

    <script>
        let hostPeer = null;
        let viewerPeer = null;
        let connections = [];

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function createHost() {
            log('åˆ›å»ºä¸»æœº...');
            
            const hostId = `test-host-${Math.random().toString(36).substr(2, 6)}`;
            hostPeer = new Peer(hostId);
            
            hostPeer.on('open', (id) => {
                log(`âœ… ä¸»æœºåˆ›å»ºæˆåŠŸï¼ŒID: ${id}`);
                document.getElementById('hostId').textContent = id;
            });
            
            hostPeer.on('connection', (conn) => {
                log(`ğŸ“¥ æ”¶åˆ°æ–°è¿æ¥: ${conn.peer}`);
                connections.push(conn);
                updateViewerCount();
                
                conn.on('open', () => {
                    log(`âœ… è§‚çœ‹è€…è¿æ¥æˆåŠŸ: ${conn.peer}`);
                    
                    // å‘é€æ¬¢è¿æ¶ˆæ¯
                    conn.send({
                        type: 'welcome',
                        message: 'æ¬¢è¿è¿æ¥åˆ°æµ‹è¯•ä¸»æœºï¼',
                        timestamp: Date.now()
                    });
                });
                
                conn.on('data', (data) => {
                    log(`ğŸ“¨ æ”¶åˆ°è§‚çœ‹è€…æ•°æ®: ${JSON.stringify(data)}`);
                    
                    // å¦‚æœæ˜¯è¯·æ±‚åˆå§‹æ•°æ®
                    if (data.type === 'request-initial-state') {
                        log('ğŸ“¤ å‘é€åˆå§‹æ•°æ®ç»™è§‚çœ‹è€…');
                        conn.send({
                            type: 'initial-state',
                            data: {
                                blocks: [
                                    { id: '1', type: 'text', content: 'æµ‹è¯•æ–‡æœ¬å—', x: 100, y: 100 },
                                    { id: '2', type: 'text', content: 'å¦ä¸€ä¸ªæµ‹è¯•å—', x: 300, y: 200 }
                                ],
                                connections: [],
                                zoom: 1,
                                pan: { x: 0, y: 0 }
                            },
                            timestamp: Date.now()
                        });
                    }
                });
                
                conn.on('close', () => {
                    log(`âŒ è§‚çœ‹è€…æ–­å¼€è¿æ¥: ${conn.peer}`);
                    connections = connections.filter(c => c.peer !== conn.peer);
                    updateViewerCount();
                });
            });
            
            hostPeer.on('error', (err) => {
                log(`âŒ ä¸»æœºé”™è¯¯: ${err.message}`);
            });
        }

        function sendTestData() {
            if (connections.length === 0) {
                log('âš ï¸ æ²¡æœ‰è¿æ¥çš„è§‚çœ‹è€…');
                return;
            }
            
            const testData = {
                type: 'test-update',
                message: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯',
                timestamp: Date.now(),
                random: Math.random()
            };
            
            log(`ğŸ“¤ å‘ ${connections.length} ä¸ªè§‚çœ‹è€…å‘é€æµ‹è¯•æ•°æ®`);
            connections.forEach(conn => {
                if (conn.open) {
                    conn.send(testData);
                }
            });
        }

        function connectToHost() {
            const targetId = document.getElementById('targetId').value.trim();
            if (!targetId) {
                log('âŒ è¯·è¾“å…¥ä¸»æœºID');
                return;
            }
            
            log(`ğŸ”— è¿æ¥åˆ°ä¸»æœº: ${targetId}`);
            document.getElementById('connectionStatus').textContent = 'è¿æ¥ä¸­...';
            
            viewerPeer = new Peer();
            
            viewerPeer.on('open', (id) => {
                log(`âœ… è§‚çœ‹è€…åˆå§‹åŒ–æˆåŠŸï¼ŒID: ${id}`);
                
                const conn = viewerPeer.connect(targetId);
                
                conn.on('open', () => {
                    log('âœ… è¿æ¥åˆ°ä¸»æœºæˆåŠŸ');
                    document.getElementById('connectionStatus').textContent = 'å·²è¿æ¥';
                    
                    // è¯·æ±‚åˆå§‹æ•°æ®
                    log('ğŸ“¤ è¯·æ±‚åˆå§‹æ•°æ®');
                    conn.send({
                        type: 'request-initial-state',
                        timestamp: Date.now()
                    });
                });
                
                conn.on('data', (data) => {
                    log(`ğŸ“¨ æ”¶åˆ°ä¸»æœºæ•°æ®: ${JSON.stringify(data)}`);
                    
                    if (data.type === 'initial-state') {
                        log('âœ… æ”¶åˆ°åˆå§‹æ•°æ®ï¼');
                        log(`æ•°æ®å†…å®¹: ${data.data.blocks.length} ä¸ªå—`);
                    }
                });
                
                conn.on('close', () => {
                    log('âŒ ä¸ä¸»æœºçš„è¿æ¥å·²æ–­å¼€');
                    document.getElementById('connectionStatus').textContent = 'å·²æ–­å¼€';
                });
                
                conn.on('error', (err) => {
                    log(`âŒ è¿æ¥é”™è¯¯: ${err.message}`);
                    document.getElementById('connectionStatus').textContent = 'è¿æ¥å¤±è´¥';
                });
            });
            
            viewerPeer.on('error', (err) => {
                log(`âŒ è§‚çœ‹è€…é”™è¯¯: ${err.message}`);
                document.getElementById('connectionStatus').textContent = 'é”™è¯¯';
            });
        }

        function updateViewerCount() {
            document.getElementById('viewerCount').textContent = connections.length;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = function() {
            log('P2Pæµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('ä½¿ç”¨è¯´æ˜ï¼š');
            log('1. ç‚¹å‡»"åˆ›å»ºä¸»æœº"æŒ‰é’®');
            log('2. å¤åˆ¶ä¸»æœºIDåˆ°è§‚çœ‹è€…ç«¯');
            log('3. ç‚¹å‡»"è¿æ¥ä¸»æœº"æµ‹è¯•P2Pè¿æ¥');
            log('4. ç‚¹å‡»"å‘é€æµ‹è¯•æ•°æ®"éªŒè¯æ•°æ®ä¼ è¾“');
        };
    </script>
</body>
</html>