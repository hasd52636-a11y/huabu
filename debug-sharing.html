<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒå±åˆ†äº«è°ƒè¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .debug-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .url-box {
            background: #f1f3f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ åŒå±åˆ†äº«åŠŸèƒ½è°ƒè¯•</h1>
    
    <div class="debug-section">
        <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
        <p>æœåŠ¡å™¨åœ°å€: <span id="serverUrl">http://localhost:3005</span></p>
        <p>localStorage åˆ†äº«æ•°é‡: <span id="shareCount">0</span></p>
        <button onclick="refreshStatus()">åˆ·æ–°çŠ¶æ€</button>
        <button onclick="clearAllShares()">æ¸…é™¤æ‰€æœ‰åˆ†äº«</button>
    </div>

    <div class="debug-section">
        <h3>ğŸ§ª æµ‹è¯•æ­¥éª¤</h3>
        <ol>
            <li><button onclick="step1()">æ­¥éª¤1: åˆ›å»ºæµ‹è¯•åˆ†äº«</button></li>
            <li><button onclick="step2()">æ­¥éª¤2: éªŒè¯åˆ†äº«æ•°æ®</button></li>
            <li><button onclick="step3()">æ­¥éª¤3: æµ‹è¯•è§‚çœ‹é“¾æ¥</button></li>
            <li><button onclick="step4()">æ­¥éª¤4: æµ‹è¯•å®æ—¶æ›´æ–°</button></li>
        </ol>
    </div>

    <div id="testResults"></div>

    <div class="debug-section">
        <h3>ğŸ“ è°ƒè¯•æ—¥å¿—</h3>
        <pre id="debugLog"></pre>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
    </div>

    <script>
        const serverUrl = 'http://localhost:3005';
        let currentTestShareId = null;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[Debug] ${message}`);
        }

        function showResult(title, content, type = 'debug-section') {
            const results = document.getElementById('testResults');
            results.innerHTML += `
                <div class="${type}">
                    <h4>${title}</h4>
                    <div>${content}</div>
                </div>
            `;
        }

        function refreshStatus() {
            const shareKeys = Object.keys(localStorage).filter(key => key.startsWith('canvas-share-'));
            document.getElementById('shareCount').textContent = shareKeys.length;
            
            log(`å‘ç° ${shareKeys.length} ä¸ªåˆ†äº«è®°å½•`);
            shareKeys.forEach(key => {
                const shareId = key.replace('canvas-share-', '');
                log(`- åˆ†äº«ID: ${shareId}`);
            });
        }

        function clearAllShares() {
            const shareKeys = Object.keys(localStorage).filter(key => key.startsWith('canvas-share-'));
            shareKeys.forEach(key => localStorage.removeItem(key));
            log(`å·²æ¸…é™¤ ${shareKeys.length} ä¸ªåˆ†äº«è®°å½•`);
            refreshStatus();
        }

        function clearLog() {
            document.getElementById('debugLog').textContent = '';
        }

        function step1() {
            log('=== æ­¥éª¤1: åˆ›å»ºæµ‹è¯•åˆ†äº« ===');
            
            currentTestShareId = 'debug-' + Date.now();
            const testData = {
                shareId: currentTestShareId,
                timestamp: Date.now(),
                canvasState: {
                    blocks: [
                        {
                            id: 'debug-block-1',
                            type: 'text',
                            x: 100,
                            y: 100,
                            width: 300,
                            height: 150,
                            content: 'ğŸ”§ è°ƒè¯•æµ‹è¯•æ¨¡å—\\n\\nåˆ›å»ºæ—¶é—´: ' + new Date().toLocaleString() + '\\n\\nå¦‚æœä½ èƒ½çœ‹åˆ°è¿™ä¸ªå†…å®¹ï¼Œè¯´æ˜åŒå±åˆ†äº«åŸºæœ¬åŠŸèƒ½æ­£å¸¸ï¼',
                            status: 'idle',
                            number: 'A01'
                        },
                        {
                            id: 'debug-block-2',
                            type: 'text',
                            x: 450,
                            y: 100,
                            width: 350,
                            height: 120,
                            content: 'âœ… æµ‹è¯•æ¨¡å— #2\\n\\nè¿™æ˜¯ç¬¬äºŒä¸ªæµ‹è¯•æ¨¡å—ï¼Œç”¨äºéªŒè¯å¤šæ¨¡å—æ˜¾ç¤ºã€‚',
                            status: 'idle',
                            number: 'A02'
                        }
                    ],
                    connections: [
                        {
                            id: 'debug-conn-1',
                            fromId: 'debug-block-1',
                            toId: 'debug-block-2',
                            instruction: 'æµ‹è¯•è¿æ¥'
                        }
                    ],
                    zoom: 1,
                    pan: { x: 0, y: 0 }
                },
                status: 'active',
                message: 'è°ƒè¯•æµ‹è¯•åˆ†äº«å·²åˆ›å»º',
                lastUpdate: Date.now()
            };

            try {
                localStorage.setItem(`canvas-share-${currentTestShareId}`, JSON.stringify(testData));
                log(`âœ… æµ‹è¯•åˆ†äº«åˆ›å»ºæˆåŠŸ: ${currentTestShareId}`);
                log(`åŒ…å« ${testData.canvasState.blocks.length} ä¸ªæ¨¡å—`);
                log(`åŒ…å« ${testData.canvasState.connections.length} ä¸ªè¿æ¥`);
                
                showResult('âœ… æ­¥éª¤1å®Œæˆ', `
                    <p>æµ‹è¯•åˆ†äº«ID: <code>${currentTestShareId}</code></p>
                    <p>æ•°æ®å¤§å°: ${JSON.stringify(testData).length} å­—ç¬¦</p>
                `, 'success');
                
                refreshStatus();
            } catch (error) {
                log(`âŒ åˆ›å»ºæµ‹è¯•åˆ†äº«å¤±è´¥: ${error.message}`);
                showResult('âŒ æ­¥éª¤1å¤±è´¥', error.message, 'error');
            }
        }

        function step2() {
            if (!currentTestShareId) {
                log('âš ï¸ è¯·å…ˆæ‰§è¡Œæ­¥éª¤1åˆ›å»ºæµ‹è¯•åˆ†äº«');
                return;
            }

            log('=== æ­¥éª¤2: éªŒè¯åˆ†äº«æ•°æ® ===');
            
            try {
                const shareData = localStorage.getItem(`canvas-share-${currentTestShareId}`);
                if (shareData) {
                    const parsedData = JSON.parse(shareData);
                    log(`âœ… åˆ†äº«æ•°æ®è¯»å–æˆåŠŸ`);
                    log(`- åˆ†äº«ID: ${parsedData.shareId}`);
                    log(`- çŠ¶æ€: ${parsedData.status}`);
                    log(`- æ¨¡å—æ•°é‡: ${parsedData.canvasState.blocks.length}`);
                    log(`- è¿æ¥æ•°é‡: ${parsedData.canvasState.connections.length}`);
                    
                    showResult('âœ… æ­¥éª¤2å®Œæˆ', `
                        <p>æ•°æ®éªŒè¯é€šè¿‡</p>
                        <pre>${JSON.stringify(parsedData, null, 2).substring(0, 500)}...</pre>
                    `, 'success');
                } else {
                    log(`âŒ æ— æ³•è¯»å–åˆ†äº«æ•°æ®`);
                    showResult('âŒ æ­¥éª¤2å¤±è´¥', 'åˆ†äº«æ•°æ®ä¸å­˜åœ¨', 'error');
                }
            } catch (error) {
                log(`âŒ éªŒè¯åˆ†äº«æ•°æ®å¤±è´¥: ${error.message}`);
                showResult('âŒ æ­¥éª¤2å¤±è´¥', error.message, 'error');
            }
        }

        function step3() {
            if (!currentTestShareId) {
                log('âš ï¸ è¯·å…ˆæ‰§è¡Œæ­¥éª¤1åˆ›å»ºæµ‹è¯•åˆ†äº«');
                return;
            }

            log('=== æ­¥éª¤3: æµ‹è¯•è§‚çœ‹é“¾æ¥ ===');
            
            const viewerUrl = `${serverUrl}?watch=${currentTestShareId}`;
            log(`ç”Ÿæˆè§‚çœ‹é“¾æ¥: ${viewerUrl}`);
            
            showResult('ğŸ”— æ­¥éª¤3: è§‚çœ‹é“¾æ¥', `
                <div class="url-box">${viewerUrl}</div>
                <button onclick="window.open('${viewerUrl}', '_blank')">åœ¨æ–°çª—å£æ‰“å¼€</button>
                <p><strong>é¢„æœŸç»“æœ:</strong> åº”è¯¥æ˜¾ç¤ºåŒ…å«2ä¸ªæ–‡æœ¬æ¨¡å—çš„ç”»å¸ƒï¼Œè€Œä¸æ˜¯ç™½å±</p>
            `, 'warning');
            
            // è‡ªåŠ¨æ‰“å¼€é“¾æ¥
            setTimeout(() => {
                window.open(viewerUrl, '_blank');
                log('å·²åœ¨æ–°çª—å£æ‰“å¼€è§‚çœ‹é“¾æ¥');
            }, 1000);
        }

        function step4() {
            if (!currentTestShareId) {
                log('âš ï¸ è¯·å…ˆæ‰§è¡Œæ­¥éª¤1åˆ›å»ºæµ‹è¯•åˆ†äº«');
                return;
            }

            log('=== æ­¥éª¤4: æµ‹è¯•å®æ—¶æ›´æ–° ===');
            
            try {
                const shareData = JSON.parse(localStorage.getItem(`canvas-share-${currentTestShareId}`));
                
                // æ›´æ–°ç¬¬ä¸€ä¸ªæ¨¡å—çš„å†…å®¹
                shareData.canvasState.blocks[0].content = `ğŸ”„ å†…å®¹å·²æ›´æ–°ï¼\\n\\næ›´æ–°æ—¶é—´: ${new Date().toLocaleString()}\\n\\nè¿™è¯æ˜å®æ—¶åŒæ­¥åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼`;
                shareData.lastUpdate = Date.now();
                
                localStorage.setItem(`canvas-share-${currentTestShareId}`, JSON.stringify(shareData));
                
                log('âœ… æµ‹è¯•æ•°æ®å·²æ›´æ–°');
                showResult('âœ… æ­¥éª¤4å®Œæˆ', `
                    <p>å·²æ›´æ–°åˆ†äº«å†…å®¹</p>
                    <p>è§‚çœ‹é¡µé¢åº”è¯¥åœ¨2ç§’å†…æ˜¾ç¤ºæ›´æ–°åçš„å†…å®¹</p>
                `, 'success');
                
            } catch (error) {
                log(`âŒ æ›´æ–°æµ‹è¯•æ•°æ®å¤±è´¥: ${error.message}`);
                showResult('âŒ æ­¥éª¤4å¤±è´¥', error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            log('è°ƒè¯•é¡µé¢å·²åŠ è½½');
            refreshStatus();
            
            // æ£€æŸ¥æœåŠ¡å™¨è¿æ¥
            fetch(serverUrl)
                .then(response => {
                    if (response.ok) {
                        log('âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸');
                    } else {
                        log('âš ï¸ æœåŠ¡å™¨å“åº”å¼‚å¸¸');
                    }
                })
                .catch(error => {
                    log(`âŒ æ— æ³•è¿æ¥æœåŠ¡å™¨: ${error.message}`);
                });
        };
    </script>
</body>
</html>