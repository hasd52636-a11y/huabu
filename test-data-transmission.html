<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®ä¼ è¾“æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        #log { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; font-family: monospace; font-size: 12px; background: #f8f9fa; }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
        input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 300px; }
        .data-display { background: #f8f9fa; border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>P2Pæ•°æ®ä¼ è¾“æµ‹è¯•</h1>
    
    <div class="section warning">
        <h3>ğŸ” æµ‹è¯•ç›®æ ‡</h3>
        <p><strong>é—®é¢˜ï¼š</strong>è§‚çœ‹è€…è¿æ¥æˆåŠŸä½†æ²¡æœ‰æ¥æ”¶åˆ°ç”»å¸ƒæ•°æ®</p>
        <p><strong>æµ‹è¯•é‡ç‚¹ï¼š</strong></p>
        <ul>
            <li>éªŒè¯ä¸»æœºæ˜¯å¦æ­£ç¡®å‘é€æ•°æ®</li>
            <li>éªŒè¯è§‚çœ‹è€…æ˜¯å¦æ­£ç¡®æ¥æ”¶æ•°æ®</li>
            <li>æ£€æŸ¥æ•°æ®æ ¼å¼å’Œå†…å®¹å®Œæ•´æ€§</li>
            <li>æµ‹è¯•å®æ—¶æ•°æ®åŒæ­¥</li>
        </ul>
    </div>

    <div class="section info">
        <h3>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h3>
        
        <div class="step">
            <strong>æ­¥éª¤ 1: æ‰“å¼€ä¸»åº”ç”¨å¹¶åˆ›å»ºåˆ†äº«</strong>
            <button class="btn-primary" onclick="openMainApp()">æ‰“å¼€ä¸»åº”ç”¨</button>
            <p style="font-size: 12px; color: #666;">
                1. åœ¨ä¸»åº”ç”¨ä¸­åˆ›å»ºä¸€äº›å†…å®¹ï¼ˆæ–‡æœ¬å—ã€å›¾ç‰‡ç­‰ï¼‰<br>
                2. ç‚¹å‡»å·¦ä¾§å·¥å…·æ çš„åˆ†äº«æŒ‰é’®<br>
                3. å¤åˆ¶åˆ†äº«é“¾æ¥å¹¶ç²˜è´´åˆ°ä¸‹é¢
            </p>
        </div>
        
        <div class="step">
            <strong>æ­¥éª¤ 2: æµ‹è¯•æ•°æ®ä¼ è¾“</strong>
            <input type="text" id="shareUrl" placeholder="ç²˜è´´åˆ†äº«é“¾æ¥..." />
            <button class="btn-success" onclick="startDataTest()">å¼€å§‹æ•°æ®æµ‹è¯•</button>
            <button class="btn-warning" onclick="openViewer()">æ‰“å¼€è§‚çœ‹é¡µé¢</button>
        </div>
        
        <div class="step">
            <strong>æ­¥éª¤ 3: å®æ—¶æ•°æ®ç›‘æ§</strong>
            <button class="btn-primary" onclick="startMonitoring()">å¼€å§‹ç›‘æ§</button>
            <button class="btn-danger" onclick="stopMonitoring()">åœæ­¢ç›‘æ§</button>
            <div class="data-display">
                <strong>æ¥æ”¶åˆ°çš„æ•°æ®ï¼š</strong>
                <div id="receivedData">ç­‰å¾…æ•°æ®...</div>
            </div>
        </div>
    </div>

    <div class="section">
        <h3>ğŸ› ï¸ å¿«é€Ÿæ“ä½œ</h3>
        <button class="btn-primary" onclick="simulateCanvasData()">æ¨¡æ‹Ÿç”»å¸ƒæ•°æ®</button>
        <button class="btn-success" onclick="testDataFormat()">æµ‹è¯•æ•°æ®æ ¼å¼</button>
        <button class="btn-warning" onclick="checkConsole()">æ£€æŸ¥æ§åˆ¶å°</button>
        <button class="btn-danger" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="section">
        <h3>ğŸ“Š æµ‹è¯•æ—¥å¿—</h3>
        <div id="log"></div>
    </div>

    <script>
        let monitoringInterval = null;
        let testShareId = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function openMainApp() {
            log('æ­£åœ¨æ‰“å¼€ä¸»åº”ç”¨...', 'info');
            window.open('http://localhost:3005/', '_blank');
            log('ä¸»åº”ç”¨å·²æ‰“å¼€ï¼Œè¯·æŒ‰ç…§æ­¥éª¤æ“ä½œï¼š', 'success');
            log('1. åˆ›å»ºä¸€äº›ç”»å¸ƒå†…å®¹', 'info');
            log('2. ç‚¹å‡»åˆ†äº«æŒ‰é’®', 'info');
            log('3. å¤åˆ¶åˆ†äº«é“¾æ¥', 'info');
        }

        function startDataTest() {
            const shareUrl = document.getElementById('shareUrl').value.trim();
            if (!shareUrl) {
                log('è¯·å…ˆè¾“å…¥åˆ†äº«é“¾æ¥', 'error');
                return;
            }

            try {
                const url = new URL(shareUrl);
                testShareId = url.searchParams.get('watch');
                
                if (!testShareId) {
                    log('âŒ æ— æ•ˆçš„åˆ†äº«é“¾æ¥æ ¼å¼', 'error');
                    return;
                }
                
                log(`âœ… åˆ†äº«ID: ${testShareId}`, 'success');
                log('å¼€å§‹æ•°æ®ä¼ è¾“æµ‹è¯•...', 'info');
                
                // æ£€æŸ¥åˆ†äº«IDæ ¼å¼
                if (testShareId.startsWith('caocao-canvas-')) {
                    log('âœ… åˆ†äº«IDæ ¼å¼æ­£ç¡®', 'success');
                } else {
                    log('âš ï¸ åˆ†äº«IDæ ¼å¼å¯èƒ½æœ‰é—®é¢˜', 'warning');
                }
                
            } catch (error) {
                log(`âŒ é“¾æ¥è§£æå¤±è´¥: ${error.message}`, 'error');
            }
        }

        function openViewer() {
            const shareUrl = document.getElementById('shareUrl').value.trim();
            if (!shareUrl) {
                log('è¯·å…ˆè¾“å…¥åˆ†äº«é“¾æ¥', 'error');
                return;
            }

            log(`æ­£åœ¨æ‰“å¼€è§‚çœ‹é¡µé¢: ${shareUrl}`, 'info');
            const viewerWindow = window.open(shareUrl, '_blank');
            
            log('è§‚çœ‹é¡µé¢å·²æ‰“å¼€ï¼Œè¯·æ£€æŸ¥ï¼š', 'success');
            log('1. è¿æ¥çŠ¶æ€æ˜¯å¦æ˜¾ç¤º"å·²è¿æ¥"', 'info');
            log('2. æ˜¯å¦æ˜¾ç¤ºç”»å¸ƒå†…å®¹', 'info');
            log('3. æŒ‰F12æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—', 'info');
            
            // ç›‘å¬è§‚çœ‹é¡µé¢çš„æ¶ˆæ¯ï¼ˆå¦‚æœæ”¯æŒï¼‰
            window.addEventListener('message', function(event) {
                if (event.origin === window.location.origin) {
                    log(`ğŸ“¨ æ”¶åˆ°è§‚çœ‹é¡µé¢æ¶ˆæ¯: ${JSON.stringify(event.data)}`, 'info');
                    updateReceivedData(event.data);
                }
            });
        }

        function startMonitoring() {
            if (monitoringInterval) {
                log('ç›‘æ§å·²åœ¨è¿è¡Œä¸­', 'warning');
                return;
            }
            
            log('å¼€å§‹å®æ—¶æ•°æ®ç›‘æ§...', 'info');
            
            monitoringInterval = setInterval(() => {
                // æ£€æŸ¥localStorageä¸­çš„åˆ†äº«æ•°æ®
                try {
                    const keys = Object.keys(localStorage);
                    const shareKeys = keys.filter(key => key.includes('share') || key.includes('canvas'));
                    
                    if (shareKeys.length > 0) {
                        log(`ğŸ“Š æ£€æµ‹åˆ° ${shareKeys.length} ä¸ªç›¸å…³å­˜å‚¨é¡¹`, 'info');
                        shareKeys.forEach(key => {
                            const data = localStorage.getItem(key);
                            if (data) {
                                try {
                                    const parsed = JSON.parse(data);
                                    log(`ğŸ“¦ ${key}: ${Object.keys(parsed).join(', ')}`, 'info');
                                } catch (e) {
                                    log(`ğŸ“¦ ${key}: ${data.substring(0, 50)}...`, 'info');
                                }
                            }
                        });
                    }
                } catch (error) {
                    log(`ç›‘æ§é”™è¯¯: ${error.message}`, 'error');
                }
            }, 5000);
            
            log('âœ… ç›‘æ§å·²å¯åŠ¨ï¼Œæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡', 'success');
        }

        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                log('âœ… ç›‘æ§å·²åœæ­¢', 'success');
            } else {
                log('ç›‘æ§æœªè¿è¡Œ', 'warning');
            }
        }

        function simulateCanvasData() {
            const mockData = {
                blocks: [
                    {
                        id: 'test-1',
                        type: 'text',
                        content: 'æµ‹è¯•æ–‡æœ¬å—',
                        x: 100,
                        y: 100,
                        width: 200,
                        height: 100,
                        number: 1
                    },
                    {
                        id: 'test-2',
                        type: 'text',
                        content: 'å¦ä¸€ä¸ªæµ‹è¯•å—',
                        x: 350,
                        y: 150,
                        width: 200,
                        height: 100,
                        number: 2
                    }
                ],
                connections: [],
                zoom: 1,
                pan: { x: 0, y: 0 }
            };
            
            log('ç”Ÿæˆæ¨¡æ‹Ÿç”»å¸ƒæ•°æ®:', 'info');
            log(`æ•°æ®å¤§å°: ${JSON.stringify(mockData).length} å­—èŠ‚`, 'info');
            log(`åŒ…å« ${mockData.blocks.length} ä¸ªå—`, 'info');
            
            updateReceivedData(mockData);
        }

        function testDataFormat() {
            log('æµ‹è¯•æ•°æ®æ ¼å¼å…¼å®¹æ€§...', 'info');
            
            const testFormats = [
                { name: 'æ ‡å‡†æ ¼å¼', data: { blocks: [], connections: [], zoom: 1, pan: { x: 0, y: 0 } } },
                { name: 'ç©ºæ•°æ®', data: null },
                { name: 'å­—ç¬¦ä¸²æ•°æ®', data: 'test string' },
                { name: 'æ•°ç»„æ•°æ®', data: [1, 2, 3] }
            ];
            
            testFormats.forEach(format => {
                try {
                    const serialized = JSON.stringify(format.data);
                    const parsed = JSON.parse(serialized);
                    log(`âœ… ${format.name}: åºåˆ—åŒ–æˆåŠŸ (${serialized.length} å­—èŠ‚)`, 'success');
                } catch (error) {
                    log(`âŒ ${format.name}: åºåˆ—åŒ–å¤±è´¥ - ${error.message}`, 'error');
                }
            });
        }

        function checkConsole() {
            log('=== æ§åˆ¶å°æ£€æŸ¥æŒ‡å— ===', 'info');
            log('è¯·åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­æŸ¥æ‰¾ä»¥ä¸‹å…³é”®æ—¥å¿—ï¼š', 'info');
            log('', 'info');
            log('ä¸»æœºç«¯æ—¥å¿—ï¼š', 'warning');
            log('- [ShareProvider] ä¸»æœºåŒæ­¥æ•°æ®', 'info');
            log('- [ShareManager] å¼€å§‹å¹¿æ’­æ•°æ®', 'info');
            log('- [ShareManager] æ•°æ®å¹¿æ’­å®Œæˆ', 'info');
            log('', 'info');
            log('è§‚çœ‹è€…ç«¯æ—¥å¿—ï¼š', 'warning');
            log('- [ShareProvider] è§‚çœ‹è€…æ¥æ”¶åˆ°æ•°æ®', 'info');
            log('- [ShareKitViewer] å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®', 'info');
            log('- [ShareProvider] æ•°æ®å·²æ›´æ–°åˆ°çŠ¶æ€', 'info');
            log('', 'info');
            log('å¦‚æœæ²¡æœ‰çœ‹åˆ°è¿™äº›æ—¥å¿—ï¼Œè¯´æ˜æ•°æ®ä¼ è¾“å­˜åœ¨é—®é¢˜', 'error');
        }

        function updateReceivedData(data) {
            const dataDiv = document.getElementById('receivedData');
            if (data) {
                const summary = typeof data === 'object' ? 
                    `ç±»å‹: ${Array.isArray(data) ? 'æ•°ç»„' : 'å¯¹è±¡'}, é”®: ${Object.keys(data).join(', ')}` :
                    `ç±»å‹: ${typeof data}, å€¼: ${data}`;
                
                dataDiv.innerHTML = `
                    <div><strong>æœ€åæ›´æ–°:</strong> ${new Date().toLocaleTimeString()}</div>
                    <div><strong>æ•°æ®æ‘˜è¦:</strong> ${summary}</div>
                    <div><strong>æ•°æ®å¤§å°:</strong> ${JSON.stringify(data).length} å­—èŠ‚</div>
                    <details>
                        <summary>å®Œæ•´æ•°æ®</summary>
                        <pre style="font-size: 10px; max-height: 200px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                    </details>
                `;
                
                log(`ğŸ“Š æ•°æ®å·²æ›´æ–°: ${summary}`, 'success');
            } else {
                dataDiv.innerHTML = 'æš‚æ— æ•°æ®';
                log('ğŸ“Š æ•°æ®å·²æ¸…ç©º', 'warning');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('æµ‹è¯•æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.onload = function() {
            log('æ•°æ®ä¼ è¾“æµ‹è¯•å·¥å…·å·²åŠ è½½', 'success');
            log('è¯·æŒ‰ç…§æµ‹è¯•æ­¥éª¤è¿›è¡Œæ•°æ®ä¼ è¾“éªŒè¯', 'info');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const autoTest = urlParams.get('auto');
            if (autoTest) {
                log('æ£€æµ‹åˆ°è‡ªåŠ¨æµ‹è¯•å‚æ•°', 'info');
                setTimeout(() => {
                    simulateCanvasData();
                    startMonitoring();
                }, 1000);
            }
        };
    </script>
</body>
</html>