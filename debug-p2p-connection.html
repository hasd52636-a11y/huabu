<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2Pè¿æ¥è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        #log { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; font-family: monospace; font-size: 12px; background: #f8f9fa; }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
        input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 300px; }
    </style>
</head>
<body>
    <h1>P2Pè¿æ¥è°ƒè¯•å·¥å…·</h1>
    
    <div class="section warning">
        <h3>ğŸ” è°ƒè¯•è¯´æ˜</h3>
        <p><strong>é—®é¢˜ï¼š</strong>è§‚çœ‹è€…è¿æ¥åˆ°åˆ†äº«ä¼šè¯åï¼Œæ˜¾ç¤º"æ­£åœ¨è¿æ¥"ä½†æ²¡æœ‰æ¥æ”¶åˆ°æ•°æ®ã€‚</p>
        <p><strong>å¯èƒ½åŸå› ï¼š</strong></p>
        <ul>
            <li>ä¸»æœºè¿˜æ²¡æœ‰å¼€å§‹åˆ†äº«ï¼ˆæ²¡æœ‰åˆ›å»ºåˆ†äº«ä¼šè¯ï¼‰</li>
            <li>P2Pè¿æ¥å¤±è´¥ï¼ˆç½‘ç»œé—®é¢˜ã€é˜²ç«å¢™ç­‰ï¼‰</li>
            <li>åˆ†äº«IDä¸åŒ¹é…æˆ–æ— æ•ˆ</li>
            <li>PeerJSæœåŠ¡å™¨è¿æ¥é—®é¢˜</li>
        </ul>
    </div>

    <div class="section info">
        <h3>ğŸ“‹ è°ƒè¯•æ­¥éª¤</h3>
        
        <div class="step">
            <strong>æ­¥éª¤ 1: æ£€æŸ¥ä¸»æœºçŠ¶æ€</strong>
            <p>ç¡®ä¿ä¸»æœºå·²ç»å¼€å§‹åˆ†äº«å¹¶ä¸”æœ‰å†…å®¹</p>
            <button class="btn-primary" onclick="openMainApp()">æ‰“å¼€ä¸»åº”ç”¨ï¼ˆä¸»æœºï¼‰</button>
            <p style="font-size: 12px; color: #666;">åœ¨ä¸»åº”ç”¨ä¸­ï¼š1) åˆ›å»ºä¸€äº›å†…å®¹ 2) ç‚¹å‡»åˆ†äº«æŒ‰é’® 3) ç¡®ä¿çœ‹åˆ°ç»¿è‰²çš„åˆ†äº«çŠ¶æ€</p>
        </div>
        
        <div class="step">
            <strong>æ­¥éª¤ 2: æµ‹è¯•åˆ†äº«é“¾æ¥</strong>
            <input type="text" id="shareUrl" placeholder="ç²˜è´´åˆ†äº«é“¾æ¥..." />
            <button class="btn-success" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
            <button class="btn-warning" onclick="openViewer()">æ‰“å¼€è§‚çœ‹é¡µé¢</button>
        </div>
        
        <div class="step">
            <strong>æ­¥éª¤ 3: æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°</strong>
            <p>æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ŒæŸ¥çœ‹ Console æ ‡ç­¾é¡µä¸­çš„æ—¥å¿—ä¿¡æ¯</p>
            <button class="btn-danger" onclick="showConsoleInstructions()">æ˜¾ç¤ºæ§åˆ¶å°æ£€æŸ¥æŒ‡å—</button>
        </div>
    </div>

    <div class="section">
        <h3>ğŸ› ï¸ å¿«é€Ÿæµ‹è¯•</h3>
        <button class="btn-primary" onclick="testPeerJS()">æµ‹è¯• PeerJS å¯ç”¨æ€§</button>
        <button class="btn-success" onclick="simulateConnection()">æ¨¡æ‹Ÿ P2P è¿æ¥</button>
        <button class="btn-warning" onclick="checkNetworkStatus()">æ£€æŸ¥ç½‘ç»œçŠ¶æ€</button>
        <button class="btn-danger" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="section">
        <h3>ğŸ“Š è°ƒè¯•æ—¥å¿—</h3>
        <div id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function openMainApp() {
            log('æ­£åœ¨æ‰“å¼€ä¸»åº”ç”¨...', 'info');
            window.open('http://localhost:3005/', '_blank');
            log('ä¸»åº”ç”¨å·²æ‰“å¼€ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š', 'success');
            log('1. åˆ›å»ºä¸€äº›å†…å®¹ï¼ˆæ–‡æœ¬å—ã€å›¾ç‰‡ç­‰ï¼‰', 'info');
            log('2. ç‚¹å‡»å·¦ä¾§å·¥å…·æ çš„åˆ†äº«æŒ‰é’®', 'info');
            log('3. ç¡®ä¿çœ‹åˆ°ç»¿è‰²çš„åˆ†äº«çŠ¶æ€æŒ‡ç¤ºå™¨', 'info');
            log('4. å¤åˆ¶åˆ†äº«é“¾æ¥å¹¶åœ¨è¿™é‡Œæµ‹è¯•', 'info');
        }

        function testConnection() {
            const shareUrl = document.getElementById('shareUrl').value.trim();
            if (!shareUrl) {
                log('è¯·å…ˆè¾“å…¥åˆ†äº«é“¾æ¥', 'error');
                return;
            }

            log(`å¼€å§‹æµ‹è¯•è¿æ¥: ${shareUrl}`, 'info');
            
            try {
                const url = new URL(shareUrl);
                const watchParam = url.searchParams.get('watch');
                
                if (!watchParam) {
                    log('âŒ é“¾æ¥æ ¼å¼é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ° watch å‚æ•°', 'error');
                    log('æ­£ç¡®æ ¼å¼åº”è¯¥æ˜¯: http://localhost:3005/?watch=caocao-canvas-xxxxx', 'warning');
                    return;
                }
                
                log(`âœ… åˆ†äº«IDæ£€æµ‹æˆåŠŸ: ${watchParam}`, 'success');
                
                // æ£€æŸ¥åˆ†äº«IDæ ¼å¼
                if (watchParam.startsWith('caocao-canvas-')) {
                    log('âœ… åˆ†äº«IDæ ¼å¼æ­£ç¡®ï¼ˆæ–°ç‰ˆæ ¼å¼ï¼‰', 'success');
                } else if (watchParam.startsWith('share-')) {
                    log('âš ï¸ æ£€æµ‹åˆ°æ—§ç‰ˆåˆ†äº«IDæ ¼å¼ï¼Œå¯èƒ½å­˜åœ¨å…¼å®¹æ€§é—®é¢˜', 'warning');
                } else {
                    log('âš ï¸ åˆ†äº«IDæ ¼å¼ä¸æ ‡å‡†ï¼Œå¯èƒ½å¯¼è‡´è¿æ¥é—®é¢˜', 'warning');
                }
                
                log('å‡†å¤‡æµ‹è¯•P2Pè¿æ¥...', 'info');
                
            } catch (error) {
                log(`âŒ é“¾æ¥æ ¼å¼é”™è¯¯: ${error.message}`, 'error');
            }
        }

        function openViewer() {
            const shareUrl = document.getElementById('shareUrl').value.trim();
            if (!shareUrl) {
                log('è¯·å…ˆè¾“å…¥åˆ†äº«é“¾æ¥', 'error');
                return;
            }

            log(`æ­£åœ¨æ‰“å¼€è§‚çœ‹é¡µé¢: ${shareUrl}`, 'info');
            window.open(shareUrl, '_blank');
            log('è§‚çœ‹é¡µé¢å·²æ‰“å¼€ï¼Œè¯·æ£€æŸ¥ï¼š', 'success');
            log('1. æ˜¯å¦æ˜¾ç¤º"æ­£åœ¨è¿æ¥åˆ†äº«ä¼šè¯"', 'info');
            log('2. è¿æ¥çŠ¶æ€æ˜¯å¦å˜ä¸º"å·²è¿æ¥"', 'info');
            log('3. æ˜¯å¦æ¥æ”¶åˆ°ç”»å¸ƒæ•°æ®', 'info');
            log('4. æŒ‰F12æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—', 'info');
        }

        function testPeerJS() {
            log('æ­£åœ¨æµ‹è¯• PeerJS å¯ç”¨æ€§...', 'info');
            
            if (typeof window.Peer === 'undefined') {
                log('âŒ PeerJS æœªåŠ è½½ï¼Œè¿™æ˜¯ä¸»è¦é—®é¢˜ï¼', 'error');
                log('è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥ index.html ä¸­æ˜¯å¦åŒ…å« PeerJS CDN', 'warning');
                log('<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>', 'info');
                return;
            }
            
            log('âœ… PeerJS å·²åŠ è½½', 'success');
            
            try {
                const testPeer = new window.Peer();
                testPeer.on('open', (id) => {
                    log(`âœ… PeerJS è¿æ¥æˆåŠŸï¼Œæµ‹è¯•ID: ${id}`, 'success');
                    testPeer.destroy();
                });
                testPeer.on('error', (err) => {
                    log(`âŒ PeerJS è¿æ¥å¤±è´¥: ${err.message}`, 'error');
                    testPeer.destroy();
                });
            } catch (error) {
                log(`âŒ PeerJS åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function simulateConnection() {
            log('å¼€å§‹æ¨¡æ‹Ÿ P2P è¿æ¥æµ‹è¯•...', 'info');
            
            // æ¨¡æ‹Ÿä¸»æœº
            log('åˆ›å»ºæ¨¡æ‹Ÿä¸»æœº...', 'info');
            setTimeout(() => {
                log('âœ… æ¨¡æ‹Ÿä¸»æœºåˆ›å»ºæˆåŠŸï¼ŒID: test-host-123', 'success');
                
                // æ¨¡æ‹Ÿè§‚çœ‹è€…è¿æ¥
                log('åˆ›å»ºæ¨¡æ‹Ÿè§‚çœ‹è€…...', 'info');
                setTimeout(() => {
                    log('âœ… æ¨¡æ‹Ÿè§‚çœ‹è€…è¿æ¥æˆåŠŸ', 'success');
                    log('âœ… æ¨¡æ‹Ÿæ•°æ®ä¼ è¾“æˆåŠŸ', 'success');
                    log('å¦‚æœå®é™…è¿æ¥å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œæˆ–é…ç½®é—®é¢˜', 'warning');
                }, 1000);
            }, 500);
        }

        function checkNetworkStatus() {
            log('æ­£åœ¨æ£€æŸ¥ç½‘ç»œçŠ¶æ€...', 'info');
            
            // æ£€æŸ¥åœ¨çº¿çŠ¶æ€
            if (navigator.onLine) {
                log('âœ… ç½‘ç»œè¿æ¥æ­£å¸¸', 'success');
            } else {
                log('âŒ ç½‘ç»œè¿æ¥æ–­å¼€', 'error');
                return;
            }
            
            // æ£€æŸ¥WebRTCæ”¯æŒ
            if (typeof RTCPeerConnection !== 'undefined') {
                log('âœ… æµè§ˆå™¨æ”¯æŒ WebRTC', 'success');
            } else {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒ WebRTC', 'error');
            }
            
            // æ£€æŸ¥æœ¬åœ°æœåŠ¡å™¨è¿æ¥
            fetch('http://localhost:3005/')
                .then(response => {
                    if (response.ok) {
                        log('âœ… æœ¬åœ°æœåŠ¡å™¨è¿æ¥æ­£å¸¸', 'success');
                    } else {
                        log('âš ï¸ æœ¬åœ°æœåŠ¡å™¨å“åº”å¼‚å¸¸', 'warning');
                    }
                })
                .catch(error => {
                    log('âŒ æ— æ³•è¿æ¥åˆ°æœ¬åœ°æœåŠ¡å™¨', 'error');
                    log('è¯·ç¡®ä¿åº”ç”¨æ­£åœ¨ http://localhost:3005 è¿è¡Œ', 'warning');
                });
        }

        function showConsoleInstructions() {
            log('=== æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥æŒ‡å— ===', 'info');
            log('1. æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·', 'info');
            log('2. ç‚¹å‡» Console æ ‡ç­¾é¡µ', 'info');
            log('3. æŸ¥æ‰¾ä»¥ä¸‹å…³é”®æ—¥å¿—ï¼š', 'info');
            log('   - [ShareProvider] å¼€å§‹è¿æ¥åˆ°ä¸»æœº', 'info');
            log('   - [ShareManager] å°è¯•è¿æ¥åˆ°ä¸»æœº', 'info');
            log('   - [ShareManager] è§‚çœ‹è€…è¿æ¥å·²å»ºç«‹', 'info');
            log('   - [ShareProvider] è§‚çœ‹è€…æ¥æ”¶åˆ°æ•°æ®', 'info');
            log('4. å¦‚æœçœ‹åˆ°é”™è¯¯ä¿¡æ¯ï¼Œè¯·å¤åˆ¶å®Œæ•´é”™è¯¯å†…å®¹', 'warning');
            log('5. å¸¸è§é”™è¯¯ç±»å‹ï¼š', 'warning');
            log('   - PeerJS ID is invalid: åˆ†äº«IDæ ¼å¼é—®é¢˜', 'warning');
            log('   - Connection failed: ç½‘ç»œè¿æ¥é—®é¢˜', 'warning');
            log('   - Peer not found: ä¸»æœºä¸åœ¨çº¿æˆ–IDé”™è¯¯', 'warning');
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('è°ƒè¯•æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.onload = function() {
            log('P2Pè¿æ¥è°ƒè¯•å·¥å…·å·²åŠ è½½', 'success');
            log('è¯·æŒ‰ç…§è°ƒè¯•æ­¥éª¤é€æ­¥æ’æŸ¥è¿æ¥é—®é¢˜', 'info');
            
            // è‡ªåŠ¨æ£€æŸ¥åŸºç¡€ç¯å¢ƒ
            setTimeout(() => {
                log('å¼€å§‹è‡ªåŠ¨ç¯å¢ƒæ£€æŸ¥...', 'info');
                checkNetworkStatus();
                testPeerJS();
            }, 1000);
        };
    </script>
</body>
</html>