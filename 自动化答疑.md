# 自动化模板系统 - 用户答疑文档

## 📋 目录

1. [基础概念](#基础概念)
2. [模板创建与保存](#模板创建与保存)
3. [自动化执行机制](#自动化执行机制)
4. [内容生成与检测](#内容生成与检测)
5. [批量下载功能](#批量下载功能)
6. [常见问题解答](#常见问题解答)
7. [高级使用技巧](#高级使用技巧)
8. [故障排除](#故障排除)

---

## 基础概念

### Q: 什么是自动化模板？
**A:** 自动化模板是一种预配置的工作流，它保存了完整的画布状态（包括模块、连接、参数设置），但不保存生成的内容。用户可以基于模板进行批量内容生成。

### Q: 自动化模板与手动模板有什么区别？
**A:** 
- **手动模板**：保存完整状态，包括生成的内容，用于复用已有工作
- **自动化模板**：只保存配置参数，清空生成内容，专门用于批量自动化执行
- **核心理念**：保存生成内容所需的所有参数，但不保存生成的内容本身

### Q: 为什么要区分这两种模板？
**A:** 因为自动化工作流的目的是批量生成新内容，而不是重复使用旧内容。保存参数而不保存内容，确保每次执行都能生成全新的结果。

---

## 模板创建与保存

### Q: 如何创建自动化模板？
**A:** 
1. 在画布上搭建完整的工作流（模块 + 连接）
2. 调试确保工作流正常运行
3. 点击"保存模板"
4. 选择"保存为自动化工作流"
5. 系统会自动清空生成内容，保留所有配置参数

### Q: 保存自动化模板时会保存哪些内容？
**A:** 系统会保存以下所有参数：
- **模块配置**：originalPrompt、aspectRatio、duration、fontSize、textColor
- **角色设置**：characterId、characterUrl、characterTimestamps
- **附件内容**：attachmentContent、attachmentFileName
- **图片元数据**：imageMetadata（参考图片、文件名等）
- **视频元数据**：videoMetadata（参考视频、时长等）
- **多图设置**：multiImageGroupId、multiImageIndex
- **悬浮菜单参数**：从功能管理加载的所有功能配置
- **连接指令**：模块间的数据流指令

### Q: 为什么保存时会出现警告提示？
**A:** 系统会显示琥珀色警告："模板保存后将不可再编辑，确认保存为自动化工作流？"这是为了提醒用户自动化模板会锁定为只读模式，避免误操作。

---

## 自动化执行机制

### Q: 自动化执行的基本流程是什么？
**A:** 
1. **工作流分析**：系统分析模块依赖关系，生成执行计划
2. **拓扑排序**：按依赖顺序排列执行节点
3. **批量数据循环**：对每条批量数据执行完整工作流
4. **节点顺序执行**：按计划依次执行每个节点
5. **内容生成检测**：等待每个节点内容生成完成
6. **自动下载**：检测并下载生成的媒体文件

### Q: 系统如何处理模块间的数据传递？
**A:** 
- **起始节点**：使用原始提示词 + 批量数据变量替换
- **后续节点**：通过ConnectionEngine获取上游数据，进行变量替换
- **变量格式**：支持 `[A01]`、`[B01]` 等模块编号引用
- **批量变量**：支持 `{data}`、`{index}`、`{total}` 等占位符

### Q: 自动化执行时原始指令会被污染吗？
**A:** 不会！系统采用了指令隔离机制：
- **显示层面**：用户看到的始终是原始指令内容
- **执行层面**：AI提交时使用解析后的完整提示词
- **全局标记**：通过 `__automationMode` 等标记区分自动化和手动模式
- **内容保护**：原始 `originalPrompt` 和 `content` 字段保持不变

---

## 内容生成与检测

### Q: 系统如何检测内容是否生成完成？
**A:** 采用多重检测机制：
- **事件驱动**：`waitForNodeCompletion()` 基于Promise的等待机制
- **完成通知**：`notifyNodeCompletion()` 由外部调用通知节点完成
- **内容验证**：`checkContentGeneration()` 验证内容非空且有效
- **重试机制**：最多3次尝试，递增等待时间（500ms、1000ms、1500ms）
- **超时保护**：10分钟超时防止永久等待

### Q: 如果上游模块内容为空会怎么处理？
**A:** 系统会给出警告但不中断执行：
```
警告：上游模块 [A01] 内容为空，可能影响生成质量
```
这样设计是为了保证自动化流程的连续性，避免因个别节点问题导致整个流程中断。

### Q: 自动化执行的等待时间如何计算？
**A:** 系统采用智能间隔调整：
- **基础间隔**：文本45秒、图片90秒、视频180秒
- **模式调整**：conservative（保守）、standard（标准）、fast（快速）
- **智能适应**：基于实际执行时间动态调整
- **缓冲时间**：额外30秒缓冲确保生成完成

---

## 批量下载功能

### Q: 自动下载支持哪些文件格式？
**A:** 
- **视频格式**：http/https URL、data:video/、.mp4/.avi/.mov/.webm
- **图片格式**：data:image/、http/https URL、.png/.jpg/.jpeg/.gif/.webp
- **文本格式**：http/https URL（如果文本内容是链接）

### Q: 浏览器批量下载会有限制吗？
**A:** 会有限制，但系统已做优化处理：
- **并发限制**：Chrome 2-3个，Firefox类似，Safari 1-2个
- **用户交互要求**：浏览器需要用户交互才能下载
- **系统优化**：
  - 顺序下载避免并发限制
  - 500ms间隔防止浏览器阻止
  - 静默下载API（File System Access API）
  - 降级方案确保兼容性

### Q: 下载文件如何命名？
**A:** 采用智能命名规则：
```
batch_{批次索引}_{节点编号}_{类型}.{扩展名}
例如：batch_1_C01_video.mp4
```

### Q: 如何处理下载失败？
**A:** 系统提供完整的错误处理：
- **重试机制**：失败自动重试，可配置次数
- **错误日志**：详细记录失败原因
- **进度跟踪**：实时显示下载状态
- **批量管理**：支持批量重试失败项目

---

## 常见问题解答

### Q: 为什么后面节点的指令框里会加载前面节点生成的内容？
**A:** 这是正常的数据流行为！系统设计就是让后续节点能够引用前面节点的生成结果。但在自动化模式下，用户看到的指令框内容不会被污染，显示的仍然是原始配置的指令。

### Q: 手动生成按钮在自动化模板中为什么被禁用？
**A:** 为了避免用户混淆和误操作。自动化模板专门用于批量执行，手动生成可能会干扰自动化流程的状态管理。

### Q: 模板保存后真的不能再编辑吗？
**A:** 自动化模板确实会锁定为只读模式，但用户可以：
- 复制模板创建新版本
- 导出模板进行修改后重新导入
- 基于现有模板创建新的工作流

### Q: 如何处理大量数据的批量执行？
**A:** 推荐使用多标签页/多浏览器策略：
- **并行处理**：每个标签页独立执行
- **资源隔离**：避免单页面限制
- **故障隔离**：一个标签页出问题不影响其他
- **合理分批**：建议2-4个标签页并行

### Q: 自动化执行过程中可以暂停或停止吗？
**A:** 可以！系统提供完整的执行控制：
- **暂停执行**：保持当前状态，可随时恢复
- **停止执行**：完全终止，重置到初始状态
- **进度监控**：实时显示执行进度和状态

---

## 高级使用技巧

### Q: 如何优化大规模批量生成的性能？
**A:** 
1. **合理分批**：根据硬件性能决定并行数量
2. **错峰执行**：避免所有实例同时启动
3. **监控资源**：注意CPU和内存使用
4. **模板优化**：简化不必要的复杂连接

### Q: 批量数据变量有哪些可用格式？
**A:** 
- **基本变量**：`{data}`、`{input}`、`{batch}`、`{content}`
- **索引变量**：`{index}`、`{number}` （从1开始）
- **总数变量**：`{total}`、`{count}`
- **进度变量**：`{progress}` （百分比）
- **时间变量**：`{date}`、`{time}`、`{datetime}`

### Q: 如何设计高效的工作流模板？
**A:** 
1. **最小化节点**：只包含必要的处理步骤
2. **清晰依赖**：避免复杂的循环依赖
3. **合理连接**：确保数据流向清晰
4. **参数复用**：利用变量引用减少重复配置

---

## 故障排除

### Q: 自动化执行卡住不动怎么办？
**A:** 
1. 检查网络连接是否正常
2. 查看浏览器控制台是否有错误信息
3. 确认API配置是否正确
4. 尝试暂停后重新开始
5. 如果问题持续，重新加载页面

### Q: 下载功能不工作怎么办？
**A:** 
1. 确认浏览器允许下载
2. 检查是否有弹窗拦截
3. 尝试手动点击下载链接测试
4. 查看生成的内容格式是否正确
5. 考虑使用不同浏览器测试

### Q: 模板加载后参数丢失怎么办？
**A:** 
1. 确认保存时选择了"自动化工作流"
2. 检查模板是否完整保存
3. 尝试重新导入模板
4. 查看浏览器localStorage是否有限制

### Q: 批量执行中途出错怎么办？
**A:** 
1. 查看错误信息确定问题类型
2. 检查剩余API配额是否充足
3. 确认网络连接稳定性
4. 考虑降低执行速度（选择conservative模式）
5. 分批处理减少单次执行量

---

## 📞 技术支持

如果遇到本文档未涵盖的问题，请：

1. 查看浏览器控制台的详细错误信息
2. 记录问题复现的具体步骤
3. 提供使用的浏览器版本和操作系统信息
4. 描述期望的行为和实际发生的情况

---

## 🔄 更新日志

- **v1.0** - 初始版本，包含基础自动化功能
- **v1.1** - 修复指令污染问题，增强内容检测
- **v1.2** - 完善下载功能，支持多格式识别
- **v1.3** - 优化模板保存，添加警告提示
- **v1.4** - 支持多实例并行执行

---

*最后更新：2024年1月*