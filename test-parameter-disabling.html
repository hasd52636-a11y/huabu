<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>参数禁用机制测试 - Phase 1</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="src/styles/parameter-panel-theme.css">
    <style>
        /* 模拟紫色主题样式 */
        .input-violet:focus {
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
        
        .select-violet:focus {
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
        
        .select-violet option:disabled {
            color: #94a3b8;
            background-color: #f1f5f9;
            font-style: italic;
        }
        
        .btn-violet-primary {
            background-color: #8b5cf6;
            color: white;
        }
        
        .btn-violet-primary:hover {
            background-color: #7c3aed;
        }
        
        .slider-violet::-webkit-slider-thumb {
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #8b5cf6;
            cursor: pointer;
            border: 2px solid #ffffff;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">参数禁用机制测试 - Phase 1</h1>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">测试说明</h2>
            <div class="space-y-2 text-sm text-gray-600">
                <p>• <strong>基础模型</strong>：nano-banana (不支持4K分辨率)</p>
                <p>• <strong>高级模型</strong>：flux-kontext-pro (支持所有分辨率和宽高比)</p>
                <p>• <strong>Sora模型</strong>：sora-2 (支持10/15/25秒，24/30fps)</p>
                <p>• <strong>Veo模型</strong>：veo3-pro (支持10/15/25/30秒，24/30/60fps)</p>
            </div>
        </div>

        <div id="test-container"></div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // 模拟模型配置数据
        const mockModelConfig = {
            'nano-banana': {
                type: 'image',
                supportedAspectRatios: ['1:1', '4:3', '16:9', '9:16'],
                supportedSizes: ['1K', '2K'], // 不支持4K
                complexity: 'basic'
            },
            'flux-kontext-pro': {
                type: 'image', 
                supportedAspectRatios: ['1:1', '4:3', '16:9', '9:16', '4:5', '5:4', '2:3', '3:2', '21:9'],
                supportedSizes: ['1K', '2K', '4K'],
                complexity: 'advanced'
            },
            'sora-2': {
                type: 'video',
                supportedAspectRatios: ['16:9', '9:16'],
                supportedDurations: ['10', '15', '25'],
                supportedFps: ['24', '30'],
                complexity: 'medium'
            },
            'veo3-pro': {
                type: 'video',
                supportedAspectRatios: ['16:9', '9:16', '1:1'],
                supportedDurations: ['10', '15', '25', '30'],
                supportedFps: ['24', '30', '60'],
                complexity: 'advanced'
            }
        };

        // 模拟参数生成函数
        const generateMockParameters = (modelId, generationType) => {
            const config = mockModelConfig[modelId];
            if (!config) return [];

            const parameters = [
                {
                    key: 'prompt',
                    label: '提示词',
                    type: 'text',
                    defaultValue: '',
                    required: true,
                    validation: { required: true, min: 1, max: 2000 },
                    category: 'basic'
                }
            ];

            if (generationType === 'image') {
                // 宽高比参数 - 显示所有选项，禁用不支持的
                const allRatios = ['1:1', '4:3', '16:9', '9:16', '4:5', '5:4', '2:3', '3:2', '21:9'];
                const disabledRatios = allRatios.filter(ratio => !config.supportedAspectRatios.includes(ratio));
                
                parameters.push({
                    key: 'aspectRatio',
                    label: '宽高比',
                    type: 'select',
                    defaultValue: '1:1',
                    required: false,
                    validation: {
                        options: allRatios,
                        disabledOptions: disabledRatios
                    },
                    category: 'basic'
                });

                // 图像尺寸参数
                const allSizes = ['1K', '2K', '4K'];
                const disabledSizes = allSizes.filter(size => !config.supportedSizes.includes(size));
                
                parameters.push({
                    key: 'imageSize',
                    label: '图像尺寸',
                    type: 'select',
                    defaultValue: '2K',
                    required: false,
                    validation: {
                        options: allSizes,
                        disabledOptions: disabledSizes
                    },
                    category: 'basic'
                });
            } else if (generationType === 'video') {
                // 宽高比参数
                const allRatios = ['16:9', '9:16', '1:1', '4:3', '21:9'];
                const disabledRatios = allRatios.filter(ratio => !config.supportedAspectRatios.includes(ratio));
                
                parameters.push({
                    key: 'aspectRatio',
                    label: '宽高比',
                    type: 'select',
                    defaultValue: '16:9',
                    required: false,
                    validation: {
                        options: allRatios,
                        disabledOptions: disabledRatios
                    },
                    category: 'basic'
                });

                // 视频时长参数
                const allDurations = ['5', '10', '15', '25', '30', '60'];
                const disabledDurations = allDurations.filter(duration => !config.supportedDurations.includes(duration));
                
                parameters.push({
                    key: 'duration',
                    label: '视频时长',
                    type: 'select',
                    defaultValue: '10',
                    required: false,
                    validation: {
                        options: allDurations,
                        disabledOptions: disabledDurations
                    },
                    category: 'basic'
                });

                // 帧率参数
                if (config.complexity !== 'basic') {
                    const allFps = ['24', '30', '60'];
                    const disabledFps = allFps.filter(fps => !config.supportedFps.includes(fps));
                    
                    parameters.push({
                        key: 'fps',
                        label: '帧率',
                        type: 'select',
                        defaultValue: '24',
                        required: false,
                        validation: {
                            options: allFps,
                            disabledOptions: disabledFps
                        },
                        category: 'advanced'
                    });
                }
            }

            return parameters;
        };

        // 简化的参数控件组件
        const ParameterControls = ({ modelId, generationType, parameters, onParameterChange }) => {
            const availableParameters = generateMockParameters(modelId, generationType);
            
            const isOptionDisabled = (param, option) => {
                return param.validation.disabledOptions?.includes(option) || false;
            };

            const renderParameterControl = (param) => {
                const value = parameters[param.key] || param.defaultValue;

                switch (param.type) {
                    case 'text':
                        return (
                            <textarea
                                value={value}
                                onChange={(e) => onParameterChange(param.key, e.target.value)}
                                placeholder="描述你想要生成的内容..."
                                className="w-full p-3 border border-slate-300 rounded-lg input-violet resize-none"
                                rows={3}
                            />
                        );
                    
                    case 'select':
                        return (
                            <select
                                value={value}
                                onChange={(e) => onParameterChange(param.key, e.target.value)}
                                className="w-full p-3 border border-slate-300 rounded-lg select-violet"
                            >
                                {param.validation.options?.map(option => {
                                    const disabled = isOptionDisabled(param, option);
                                    return (
                                        <option 
                                            key={option} 
                                            value={option}
                                            disabled={disabled}
                                            style={disabled ? { color: '#94a3b8', fontStyle: 'italic' } : {}}
                                        >
                                            {option}{disabled ? ' (当前模型不支持)' : ''}
                                            {param.key === 'duration' && !disabled ? ' 秒' : ''}
                                        </option>
                                    );
                                })}
                            </select>
                        );
                    
                    default:
                        return (
                            <input
                                type="text"
                                value={value}
                                onChange={(e) => onParameterChange(param.key, e.target.value)}
                                className="w-full p-3 border border-slate-300 rounded-lg input-violet"
                            />
                        );
                }
            };

            const renderCompactParameterGroup = (params) => {
                const compactPairs = [];
                const remainingParams = [];
                const usedParams = new Set();

                // 配对逻辑
                const compactCombinations = [
                    ['aspectRatio', 'duration'],
                    ['aspectRatio', 'imageSize'],
                    ['fps', 'motionStrength']
                ];

                for (const [param1Key, param2Key] of compactCombinations) {
                    const param1 = params.find(p => p.key === param1Key && !usedParams.has(p.key));
                    const param2 = params.find(p => p.key === param2Key && !usedParams.has(p.key));
                    
                    if (param1 && param2) {
                        compactPairs.push([param1, param2]);
                        usedParams.add(param1.key);
                        usedParams.add(param2.key);
                    } else if (param1) {
                        compactPairs.push([param1]);
                        usedParams.add(param1.key);
                    } else if (param2) {
                        compactPairs.push([param2]);
                        usedParams.add(param2.key);
                    }
                }

                params.forEach(param => {
                    if (!usedParams.has(param.key)) {
                        remainingParams.push(param);
                    }
                });

                return (
                    <div className="space-y-6">
                        {compactPairs.map(([param1, param2], pairIndex) => (
                            <div key={`pair-${pairIndex}`} className={param2 ? "grid grid-cols-1 sm:grid-cols-2 gap-4" : ""}>
                                <div className="space-y-2">
                                    <label className="block text-sm font-medium text-slate-700">
                                        {param1.label}
                                        {param1.required && <span className="text-red-500 ml-1">*</span>}
                                    </label>
                                    {renderParameterControl(param1)}
                                </div>

                                {param2 && (
                                    <div className="space-y-2">
                                        <label className="block text-sm font-medium text-slate-700">
                                            {param2.label}
                                            {param2.required && <span className="text-red-500 ml-1">*</span>}
                                        </label>
                                        {renderParameterControl(param2)}
                                    </div>
                                )}
                            </div>
                        ))}

                        {remainingParams.map(param => (
                            <div key={param.key} className="space-y-2">
                                <label className="block text-sm font-medium text-slate-700">
                                    {param.label}
                                    {param.required && <span className="text-red-500 ml-1">*</span>}
                                </label>
                                {renderParameterControl(param)}
                            </div>
                        ))}
                    </div>
                );
            };

            const basicParameters = availableParameters.filter(param => 
                param.category === 'basic' || !param.category
            );
            const advancedParameters = availableParameters.filter(param => 
                param.category === 'advanced'
            );

            return (
                <div className="space-y-8">
                    {/* 顶部说明文字 */}
                    <div className="bg-violet-50 border border-violet-200 rounded-lg p-4">
                        <div className="flex items-start gap-2">
                            <svg className="w-4 h-4 text-violet-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                            </svg>
                            <p className="text-sm text-violet-700">
                                页面仅显示当前模型支持的参数，灰色选项表示该模型不支持
                            </p>
                        </div>
                    </div>

                    {/* 基础参数 - 使用紧凑布局 */}
                    {renderCompactParameterGroup(basicParameters)}

                    {/* 高级参数 */}
                    {advancedParameters.length > 0 && (
                        <details className="border border-slate-200 rounded-lg">
                            <summary className="p-4 cursor-pointer text-sm font-medium text-slate-700 hover:bg-slate-50 rounded-lg transition-colors">
                                高级参数
                            </summary>
                            <div className="p-4 pt-0">
                                <div className="space-y-6">
                                    {advancedParameters.map(param => (
                                        <div key={param.key} className="space-y-2">
                                            <label className="block text-sm font-medium text-slate-700">
                                                {param.label}
                                                {param.required && <span className="text-red-500 ml-1">*</span>}
                                            </label>
                                            {renderParameterControl(param)}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </details>
                    )}
                </div>
            );
        };

        // 主测试组件
        const ParameterTestApp = () => {
            const [selectedModel, setSelectedModel] = useState('nano-banana');
            const [generationType, setGenerationType] = useState('image');
            const [parameters, setParameters] = useState({ prompt: '' });

            const handleParameterChange = (key, value) => {
                setParameters(prev => ({ ...prev, [key]: value }));
            };

            const handleModelChange = (newModel) => {
                setSelectedModel(newModel);
                const config = mockModelConfig[newModel];
                if (config) {
                    setGenerationType(config.type);
                    // 重置参数
                    setParameters({ prompt: '' });
                }
            };

            return (
                <div className="space-y-6">
                    {/* 模型选择器 */}
                    <div className="bg-white rounded-lg shadow p-6">
                        <h3 className="text-lg font-semibold mb-4">选择测试模型</h3>
                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                            {Object.keys(mockModelConfig).map(modelId => {
                                const config = mockModelConfig[modelId];
                                return (
                                    <button
                                        key={modelId}
                                        onClick={() => handleModelChange(modelId)}
                                        className={`p-3 rounded-lg border text-sm font-medium transition-colors ${
                                            selectedModel === modelId
                                                ? 'bg-violet-100 border-violet-300 text-violet-700'
                                                : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50'
                                        }`}
                                    >
                                        <div className="font-medium">{modelId}</div>
                                        <div className="text-xs text-gray-500 mt-1">
                                            {config.type} • {config.complexity}
                                        </div>
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {/* 参数面板 */}
                    <div className="bg-white rounded-lg shadow p-6">
                        <div className="flex items-center justify-between mb-6">
                            <h3 className="text-lg font-semibold">
                                参数配置 - {selectedModel} ({generationType})
                            </h3>
                            <span className="text-sm text-gray-500">
                                复杂度: {mockModelConfig[selectedModel]?.complexity}
                            </span>
                        </div>
                        
                        <ParameterControls
                            modelId={selectedModel}
                            generationType={generationType}
                            parameters={parameters}
                            onParameterChange={handleParameterChange}
                        />
                    </div>

                    {/* 当前参数值显示 */}
                    <div className="bg-gray-50 rounded-lg p-4">
                        <h4 className="font-medium mb-2">当前参数值：</h4>
                        <pre className="text-sm text-gray-600 bg-white p-3 rounded border overflow-auto">
                            {JSON.stringify(parameters, null, 2)}
                        </pre>
                    </div>
                </div>
            );
        };

        // 渲染应用
        ReactDOM.render(<ParameterTestApp />, document.getElementById('test-container'));
    </script>
</body>
</html>