<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒå±åˆ†äº«åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #007acc;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #005a9e; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .test-result {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ”„ åŒå±åˆ†äº«åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ğŸ“‹ æµ‹è¯•æ¸…å•</h2>
        <div id="test-checklist">
            <div>âœ… å¼€å‘æœåŠ¡å™¨è¿è¡ŒçŠ¶æ€</div>
            <div>â³ åˆ†äº«æŒ‰é’®æ¸²æŸ“æµ‹è¯•</div>
            <div>â³ APIè·¯ç”±è¿é€šæ€§æµ‹è¯•</div>
            <div>â³ åˆ†äº«ä¼šè¯åˆ›å»ºæµ‹è¯•</div>
            <div>â³ è§‚çœ‹æ¨¡å¼åˆ‡æ¢æµ‹è¯•</div>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸŒ æœåŠ¡å™¨è¿é€šæ€§æµ‹è¯•</h2>
        <button onclick="testServerConnection()">æµ‹è¯•æœåŠ¡å™¨è¿æ¥</button>
        <div id="server-status" class="status info">ç­‰å¾…æµ‹è¯•...</div>
    </div>

    <div class="test-section">
        <h2>ğŸ”— APIè·¯ç”±æµ‹è¯•</h2>
        <button onclick="testCreateShareAPI()">æµ‹è¯•åˆ›å»ºåˆ†äº«API</button>
        <button onclick="testGetShareAPI()">æµ‹è¯•è·å–åˆ†äº«API</button>
        <div id="api-status" class="status info">ç­‰å¾…æµ‹è¯•...</div>
        <div id="api-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ¯ åˆ†äº«åŠŸèƒ½é›†æˆæµ‹è¯•</h2>
        <button onclick="testShareButtonIntegration()">æµ‹è¯•åˆ†äº«æŒ‰é’®é›†æˆ</button>
        <button onclick="testViewerModeSwitch()">æµ‹è¯•è§‚çœ‹æ¨¡å¼åˆ‡æ¢</button>
        <div id="integration-status" class="status info">ç­‰å¾…æµ‹è¯•...</div>
        <div id="integration-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ”„ å®Œæ•´æµç¨‹æµ‹è¯•</h2>
        <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
        <div id="full-test-status" class="status info">ç­‰å¾…æµ‹è¯•...</div>
        <div id="full-test-result" class="test-result"></div>
    </div>

    <script>
        // æµ‹è¯•æœåŠ¡å™¨è¿æ¥
        async function testServerConnection() {
            const statusEl = document.getElementById('server-status');
            statusEl.className = 'status warning';
            statusEl.textContent = 'æ­£åœ¨æµ‹è¯•æœåŠ¡å™¨è¿æ¥...';
            
            try {
                const response = await fetch('http://localhost:3005');
                if (response.ok) {
                    statusEl.className = 'status success';
                    statusEl.textContent = 'âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸';
                    updateChecklist(0, 'âœ… å¼€å‘æœåŠ¡å™¨è¿è¡ŒçŠ¶æ€');
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = `âŒ æœåŠ¡å™¨å“åº”å¼‚å¸¸: ${response.status}`;
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error.message}`;
            }
        }

        // æµ‹è¯•åˆ›å»ºåˆ†äº«API
        async function testCreateShareAPI() {
            const statusEl = document.getElementById('api-status');
            const resultEl = document.getElementById('api-result');
            
            statusEl.className = 'status warning';
            statusEl.textContent = 'æ­£åœ¨æµ‹è¯•åˆ›å»ºåˆ†äº«API...';
            
            try {
                const testSession = {
                    id: 'test-session-' + Date.now(),
                    hostId: 'test-host',
                    title: 'æµ‹è¯•åˆ†äº«ä¼šè¯',
                    canvasState: {
                        blocks: [],
                        connections: [],
                        zoom: 1,
                        pan: { x: 0, y: 0 }
                    }
                };

                const response = await fetch('http://localhost:3005/api/share/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testSession)
                });

                const result = await response.json();
                
                if (response.ok) {
                    statusEl.className = 'status success';
                    statusEl.textContent = 'âœ… åˆ›å»ºåˆ†äº«APIæµ‹è¯•æˆåŠŸ';
                    resultEl.textContent = JSON.stringify(result, null, 2);
                    window.testSessionId = result.sessionId;
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'âŒ åˆ›å»ºåˆ†äº«APIæµ‹è¯•å¤±è´¥';
                    resultEl.textContent = JSON.stringify(result, null, 2);
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `âŒ APIè¯·æ±‚å¤±è´¥: ${error.message}`;
                resultEl.textContent = error.stack;
            }
        }

        // æµ‹è¯•è·å–åˆ†äº«API
        async function testGetShareAPI() {
            if (!window.testSessionId) {
                alert('è¯·å…ˆè¿è¡Œåˆ›å»ºåˆ†äº«APIæµ‹è¯•');
                return;
            }

            const statusEl = document.getElementById('api-status');
            const resultEl = document.getElementById('api-result');
            
            statusEl.className = 'status warning';
            statusEl.textContent = 'æ­£åœ¨æµ‹è¯•è·å–åˆ†äº«API...';
            
            try {
                const response = await fetch(`http://localhost:3005/api/share/${window.testSessionId}`);
                const result = await response.json();
                
                if (response.ok) {
                    statusEl.className = 'status success';
                    statusEl.textContent = 'âœ… è·å–åˆ†äº«APIæµ‹è¯•æˆåŠŸ';
                    resultEl.textContent = JSON.stringify(result, null, 2);
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'âŒ è·å–åˆ†äº«APIæµ‹è¯•å¤±è´¥';
                    resultEl.textContent = JSON.stringify(result, null, 2);
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `âŒ APIè¯·æ±‚å¤±è´¥: ${error.message}`;
                resultEl.textContent = error.stack;
            }
        }

        // æµ‹è¯•åˆ†äº«æŒ‰é’®é›†æˆ
        function testShareButtonIntegration() {
            const statusEl = document.getElementById('integration-status');
            const resultEl = document.getElementById('integration-result');
            
            statusEl.className = 'status warning';
            statusEl.textContent = 'æ­£åœ¨æµ‹è¯•åˆ†äº«æŒ‰é’®é›†æˆ...';
            
            // æ‰“å¼€ä¸»åº”ç”¨å¹¶æ£€æŸ¥åˆ†äº«æŒ‰é’®
            const mainApp = window.open('http://localhost:3005', '_blank');
            
            setTimeout(() => {
                try {
                    // æ£€æŸ¥åˆ†äº«æŒ‰é’®æ˜¯å¦å­˜åœ¨
                    const hasShareButton = mainApp.document.querySelector('[title*="åˆ†äº«"]') || 
                                         mainApp.document.querySelector('[class*="share"]') ||
                                         mainApp.document.querySelector('button:contains("åˆ†äº«")');
                    
                    if (hasShareButton) {
                        statusEl.className = 'status success';
                        statusEl.textContent = 'âœ… åˆ†äº«æŒ‰é’®é›†æˆæ­£å¸¸';
                        resultEl.textContent = 'åˆ†äº«æŒ‰é’®å·²æ­£ç¡®æ¸²æŸ“åœ¨ä¸»åº”ç”¨ä¸­';
                        updateChecklist(1, 'âœ… åˆ†äº«æŒ‰é’®æ¸²æŸ“æµ‹è¯•');
                    } else {
                        statusEl.className = 'status error';
                        statusEl.textContent = 'âŒ æœªæ‰¾åˆ°åˆ†äº«æŒ‰é’®';
                        resultEl.textContent = 'åœ¨ä¸»åº”ç”¨ä¸­æœªæ‰¾åˆ°åˆ†äº«æŒ‰é’®å…ƒç´ ';
                    }
                } catch (error) {
                    statusEl.className = 'status warning';
                    statusEl.textContent = 'âš ï¸ æ— æ³•æ£€æµ‹åˆ†äº«æŒ‰é’®ï¼ˆè·¨åŸŸé™åˆ¶ï¼‰';
                    resultEl.textContent = 'ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæ— æ³•ç›´æ¥æ£€æµ‹ã€‚è¯·æ‰‹åŠ¨æ£€æŸ¥ä¸»åº”ç”¨ä¸­çš„åˆ†äº«æŒ‰é’®ã€‚';
                }
            }, 2000);
        }

        // æµ‹è¯•è§‚çœ‹æ¨¡å¼åˆ‡æ¢
        function testViewerModeSwitch() {
            const statusEl = document.getElementById('integration-status');
            const resultEl = document.getElementById('integration-result');
            
            statusEl.className = 'status warning';
            statusEl.textContent = 'æ­£åœ¨æµ‹è¯•è§‚çœ‹æ¨¡å¼åˆ‡æ¢...';
            
            // ä½¿ç”¨æµ‹è¯•ä¼šè¯IDæ‰“å¼€è§‚çœ‹æ¨¡å¼
            const testSessionId = window.testSessionId || 'test-session-123';
            const viewerUrl = `http://localhost:3005?watch=${testSessionId}`;
            
            const viewerWindow = window.open(viewerUrl, '_blank');
            
            setTimeout(() => {
                statusEl.className = 'status success';
                statusEl.textContent = 'âœ… è§‚çœ‹æ¨¡å¼åˆ‡æ¢æµ‹è¯•å®Œæˆ';
                resultEl.textContent = `è§‚çœ‹æ¨¡å¼URL: ${viewerUrl}\nè¯·æ£€æŸ¥æ–°çª—å£æ˜¯å¦æ­£ç¡®æ˜¾ç¤ºè§‚çœ‹ç•Œé¢ã€‚`;
                updateChecklist(4, 'âœ… è§‚çœ‹æ¨¡å¼åˆ‡æ¢æµ‹è¯•');
            }, 1000);
        }

        // è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runFullTest() {
            const statusEl = document.getElementById('full-test-status');
            const resultEl = document.getElementById('full-test-result');
            
            statusEl.className = 'status warning';
            statusEl.textContent = 'æ­£åœ¨è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹...';
            
            let testResults = [];
            
            try {
                // 1. æœåŠ¡å™¨è¿æ¥æµ‹è¯•
                testResults.push('1. æµ‹è¯•æœåŠ¡å™¨è¿æ¥...');
                await testServerConnection();
                testResults.push('   âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸');
                
                // 2. APIæµ‹è¯•
                testResults.push('2. æµ‹è¯•APIè·¯ç”±...');
                await testCreateShareAPI();
                testResults.push('   âœ… åˆ›å»ºåˆ†äº«APIæ­£å¸¸');
                
                await new Promise(resolve => setTimeout(resolve, 500));
                await testGetShareAPI();
                testResults.push('   âœ… è·å–åˆ†äº«APIæ­£å¸¸');
                
                // 3. é›†æˆæµ‹è¯•
                testResults.push('3. æµ‹è¯•åŠŸèƒ½é›†æˆ...');
                testShareButtonIntegration();
                testResults.push('   âœ… åˆ†äº«æŒ‰é’®é›†æˆæµ‹è¯•å®Œæˆ');
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                testViewerModeSwitch();
                testResults.push('   âœ… è§‚çœ‹æ¨¡å¼åˆ‡æ¢æµ‹è¯•å®Œæˆ');
                
                statusEl.className = 'status success';
                statusEl.textContent = 'âœ… å®Œæ•´æµ‹è¯•æµç¨‹å®Œæˆ';
                
                updateChecklist(2, 'âœ… APIè·¯ç”±è¿é€šæ€§æµ‹è¯•');
                updateChecklist(3, 'âœ… åˆ†äº«ä¼šè¯åˆ›å»ºæµ‹è¯•');
                
            } catch (error) {
                testResults.push(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯';
            }
            
            resultEl.textContent = testResults.join('\n');
        }

        // æ›´æ–°æµ‹è¯•æ¸…å•
        function updateChecklist(index, text) {
            const checklist = document.getElementById('test-checklist');
            const items = checklist.children;
            if (items[index]) {
                items[index].textContent = text;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•æœåŠ¡å™¨è¿æ¥
        window.addEventListener('load', () => {
            setTimeout(testServerConnection, 1000);
        });
    </script>
</body>
</html>