# 语音控制功能测试指南 - 神马API Realtime版本

## 🎯 新功能特性

### 1. **双向实时语音对话**
- ✅ 用户语音 → AI实时识别和理解
- ✅ AI回复 → 实时语音播放
- ✅ 无需"曹操"唤醒词，直接对话
- ✅ 支持语音指令自动执行

### 2. **两种语音模式**
- 🚀 **实时语音模式**：使用神马API Realtime WebSocket
- 🔄 **浏览器语音模式**：使用浏览器Web Speech API（备用）

### 3. **智能指令识别**
- 自动识别生成图片指令
- 自动识别生成视频指令  
- 自动识别生成文本指令
- 内容自动添加到画布

## 🎤 使用方法

### 步骤1：配置API密钥
1. 点击右侧边栏的"设置"⚙️按钮
2. 在"API提供商配置"中选择"神马"
3. 输入神马API密钥
4. 点击"保存配置"

### 步骤2：激活语音控制
1. 点击右侧边栏的"曹操"标签页
2. 点击"语音控制"按钮
3. 浏览器会请求麦克风权限，点击"允许"
4. 看到"实时对话"绿色状态表示连接成功

### 步骤3：开始语音对话
直接对着麦克风说话，例如：
- "帮我生成一张蓝天白云的图片"
- "写一首关于春天的诗"
- "制作一个10秒的海浪视频"
- "创建一个产品介绍文案"

## 🔧 技术实现

### Realtime WebSocket连接
```javascript
// 连接到神马API Realtime端点
const wsUrl = baseUrl.replace('https://', 'wss://') + '/v1/realtime';
const ws = new WebSocket(wsUrl);

// 配置会话参数
const sessionConfig = {
  modalities: ['text', 'audio'],
  voice: 'alloy',
  input_audio_format: 'pcm16',
  output_audio_format: 'pcm16',
  turn_detection: {
    type: 'server_vad',
    threshold: 0.5
  }
};
```

### 音频处理流程
1. **录音**：MediaRecorder录制用户语音
2. **转换**：转换为PCM16格式
3. **发送**：通过WebSocket发送到API
4. **接收**：接收AI语音回复
5. **播放**：实时播放AI语音

### 指令解析
```javascript
// 自动识别生成指令
if (response.includes('生成图片')) {
  executeCommand('generate_image', extractContent(response));
} else if (response.includes('生成视频')) {
  executeCommand('generate_video', extractContent(response));
}
```

## 🌟 优势对比

### 神马API Realtime模式 vs 浏览器语音模式

| 特性 | Realtime模式 | 浏览器模式 |
|------|-------------|-----------|
| 语音识别 | ✅ 服务器端，更准确 | ⚠️ 浏览器端，依赖网络 |
| AI语音回复 | ✅ 实时语音播放 | ❌ 仅文字回复 |
| 连接稳定性 | ✅ WebSocket长连接 | ⚠️ 依赖浏览器支持 |
| 延迟 | ✅ 低延迟 | ⚠️ 较高延迟 |
| 兼容性 | ✅ 不依赖浏览器 | ❌ 仅Chrome/Edge |
| 功能完整性 | ✅ 完整对话体验 | ⚠️ 基础语音识别 |

## 🔍 故障排除

### 问题1：连接失败，自动降级到浏览器模式
**原因**：
- API密钥未配置或无效
- 网络连接问题
- WebSocket连接被阻止

**解决方案**：
1. 检查API密钥配置
2. 确认网络连接正常
3. 检查防火墙/代理设置

### 问题2：语音识别不准确
**解决方案**：
- 在安静环境中使用
- 说话清晰，语速适中
- 确保麦克风质量良好
- 尝试切换语音模式

### 问题3：AI语音播放失败
**解决方案**：
- 检查浏览器音频权限
- 确认扬声器/耳机正常
- 刷新页面重试

## 📱 浏览器兼容性

### 完全支持（Realtime模式）：
- ✅ Chrome 80+
- ✅ Edge 80+
- ✅ Safari 14+
- ✅ Firefox 80+

### 部分支持（仅浏览器模式）：
- ⚠️ 较旧版本浏览器

## 🎯 最佳实践

### 1. 环境准备
- 使用有线网络或稳定WiFi
- 安静的使用环境
- 质量良好的麦克风

### 2. 语音技巧
- 说话清晰，语速适中
- 指令要具体明确
- 避免背景噪音干扰

### 3. 指令示例
```
✅ 好的指令：
"帮我生成一张夕阳下的海滩图片"
"写一段关于人工智能发展的介绍"
"制作一个15秒的城市夜景视频"

❌ 避免的指令：
"生成图片"（太模糊）
"写点什么"（不具体）
"做个视频"（缺少描述）
```

## 🚀 部署验证

部署后请验证以下功能：
- [ ] 麦克风权限正常获取
- [ ] WebSocket连接成功建立
- [ ] 语音识别准确工作
- [ ] AI语音回复正常播放
- [ ] 指令自动执行到画布
- [ ] 模式切换功能正常

完成验证后，用户即可享受完整的语音交互体验！